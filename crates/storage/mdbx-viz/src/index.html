<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>MDBX Live Viz</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{background:#0d1117;color:#c9d1d9;font-family:'SF Mono','Fira Code','Cascadia Code',monospace;height:100%;overflow:hidden}
body{display:flex;flex-direction:row;height:100%}
#main-panel{flex:1;display:flex;flex-direction:column;padding:16px;overflow:hidden;min-width:0}
#side-panel{flex:0 0 540px;border-left:1px solid #30363d;overflow-y:auto;padding:16px;background:#161b22}
h1{color:#f0f6fc;font-size:18px;margin-bottom:2px}
.subtitle{color:#8b949e;font-size:12px;margin-bottom:10px}
.sub-row{display:flex;align-items:baseline;gap:12px;margin-bottom:6px;flex-wrap:wrap}
.sub-row .subtitle{margin-bottom:0;flex-shrink:0}
.sub-row .viz-controls{margin-bottom:0;margin-left:auto}
.controls{margin-bottom:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.controls button{background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:3px 10px;border-radius:4px;cursor:pointer;font-family:inherit;font-size:12px}
.controls button:hover{background:#30363d}
.zoom-info{font-size:11px;color:#8b949e}
.status-bar{display:flex;gap:12px;align-items:center;margin-bottom:6px;font-size:11px}
.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle}
.dot.connected{background:#4ade80}.dot.disconnected{background:#f87171}.dot.connecting{background:#facc15}
.stat-label{color:#8b949e}.stat-value{color:#c9d1d9;font-weight:600}
#canvas-wrap{border:1px solid #30363d;border-radius:6px;overflow:hidden;background:#000;position:relative;cursor:crosshair;flex:1;min-height:0}
canvas{display:block;image-rendering:pixelated;width:100%;height:100%}
#tooltip{position:fixed;background:#1c2128;border:1px solid #30363d;border-radius:6px;padding:8px 12px;font-size:12px;pointer-events:none;display:none;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,.4);max-width:360px}
#tooltip .tt-row{display:flex;align-items:center;gap:6px}
#tooltip .tt-swatch{width:10px;height:10px;border-radius:2px;flex-shrink:0;border:1px solid rgba(255,255,255,0.2)}
#tooltip .tt-name{color:#f0f6fc;font-weight:600}
#tooltip .tt-detail{color:#8b949e;margin-top:2px}
#side-panel h2{color:#f0f6fc;font-size:14px;margin-bottom:8px}
.viz-controls{margin-bottom:12px;font-size:11px}
.viz-controls label{display:inline-flex;align-items:center;gap:4px;margin-right:10px;cursor:pointer;color:#8b949e}
.viz-controls label:hover{color:#c9d1d9}
.viz-controls input[type=checkbox]{accent-color:#58a6ff}
.viz-controls input[type=range]{width:100px;accent-color:#58a6ff}
.fade-val{color:#c9d1d9;min-width:35px;display:inline-block}
table{width:100%;border-collapse:collapse;font-size:11px;background:#0d1117;border:1px solid #30363d;border-radius:6px;overflow:hidden;table-layout:fixed}
td,th{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
th{text-align:left;padding:6px 8px;background:#1c2128;color:#8b949e;font-weight:500;border-bottom:1px solid #30363d;font-size:10px;text-transform:uppercase;position:sticky;top:0}
td{padding:5px 8px;border-bottom:1px solid #21262d}
tr.tbl-row{cursor:pointer;transition:background 0.1s}
tr.tbl-row:hover td{background:#1c2128}
tr.tbl-row.active td{background:#1c2128;outline:1px solid #58a6ff}
.pct-bar{display:inline-block;height:6px;border-radius:3px;margin-right:6px;vertical-align:middle}
.swatch-cell{width:12px;height:12px;border-radius:2px;flex-shrink:0}
#loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#8b949e;font-size:14px;gap:12px}
#load-bar-wrap{width:280px;height:6px;background:#21262d;border-radius:3px;overflow:hidden;display:none}
#load-bar{height:100%;width:0;background:#58a6ff;border-radius:3px;transition:width 0.15s}
#flame-wrap{border:1px solid #30363d;border-radius:0 0 6px 6px;margin-top:-1px;background:#0d1117}
#flame-wrap canvas{display:block}
.spark-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:10px}
.spark-label{width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#8b949e}
.spark-cv{border:1px solid #21262d;border-radius:2px;background:#0d1117}
.spark-val{color:#c9d1d9;min-width:30px;text-align:right}
.tree-card{background:#1c2128;border:1px solid #30363d;border-radius:4px;padding:6px 8px;margin-bottom:4px;font-size:10px;cursor:pointer}
.tree-card:hover{border-color:#58a6ff}
.tree-card .tree-name{color:#f0f6fc;font-weight:600;font-size:11px}
.tree-card .tree-stat{color:#8b949e;margin-top:2px}
.tree-card .tree-bar{display:flex;gap:1px;margin-top:3px;height:6px;border-radius:2px;overflow:hidden}
.tree-card .tree-seg{height:100%}
.cache-stat{display:flex;justify-content:space-between;align-items:center;font-size:10px;padding:2px 0}
.cache-bar{height:4px;border-radius:2px;background:#21262d;flex:1;margin:0 6px;position:relative;overflow:hidden}
.cache-fill{height:100%;border-radius:2px;background:#4ade80;position:absolute;left:0;top:0}
.cache-pct{color:#4ade80;font-weight:600;min-width:36px;text-align:right}
.cache-label{color:#8b949e;min-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fault-cnt{color:#d946ef;font-size:10px;margin-left:4px}
.block-card{background:#1c2128;border:1px solid #30363d;border-radius:4px;padding:6px 8px;margin-bottom:3px;font-size:10px;cursor:pointer;transition:border-color 0.15s}
.block-card:hover{border-color:#58a6ff}
.block-card.replaying{border-color:#f59e0b;background:#1e1b13}
.block-card.recording{border-color:#4ade80;animation:pulse-border 1s infinite}
.block-card .block-num{color:#f0f6fc;font-weight:600;font-size:11px}
.block-card .block-stat{color:#8b949e;margin-top:1px}
@keyframes pulse-border{0%,100%{border-color:#4ade80}50%{border-color:#166534}}
#block-live{cursor:pointer;font-size:10px;margin-left:6px;user-select:none}
.utbl-row{display:flex;align-items:center;gap:6px;padding:3px 4px;font-size:10px;cursor:pointer}
.utbl-row:hover{background:#1c2128}
.utbl-row.active{background:#1c2128;outline:1px solid #58a6ff}
.utbl-sw{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.utbl-name{width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#8b949e}
.utbl-spark{flex-shrink:0}
.utbl-cache{flex:1;min-width:0}
.utbl-cache-bar-wrap{width:100%;height:6px;background:#21262d;border-radius:3px;overflow:hidden}
.utbl-cache-fill{height:100%;border-radius:3px;transition:width 0.3s}
.utbl-cache-pct{text-align:center;font-size:9px;color:#4ade80;font-weight:600;margin-top:1px;line-height:1}
.utbl-diff{width:52px;text-align:right;font-size:9px}
.utbl-faults{width:36px;text-align:right;color:#d946ef;font-size:9px}
#block-panel::-webkit-scrollbar,#side-panel::-webkit-scrollbar{width:6px}
#block-panel::-webkit-scrollbar-track,#side-panel::-webkit-scrollbar-track{background:#161b22}
#block-panel::-webkit-scrollbar-thumb,#side-panel::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
#block-panel::-webkit-scrollbar-thumb:hover,#side-panel::-webkit-scrollbar-thumb:hover{background:#484f58}
#block-panel,#side-panel{scrollbar-width:thin;scrollbar-color:#30363d #161b22}
</style>
</head>
<body>
<div id="main-panel">
  <h1>MDBX Live Viz</h1>
  <div class="sub-row">
    <div class="subtitle" id="subtitle">Loading...</div>
    <div class="viz-controls">
      <label><input type="checkbox" id="chk-read" checked> <span style="color:#3c82f6">&#9632;</span> Reads</label>
      <label><input type="checkbox" id="chk-write" checked> <span style="color:#ef4444">&#9632;</span> Writes</label>
      <label><input type="checkbox" id="chk-free" checked> <span style="color:#eab308">&#9632;</span> Frees</label>
      <label><input type="checkbox" id="chk-fixw"> Fixed Width</label>
      <label><input type="checkbox" id="chk-trails" checked> Trails</label>
      <label><input type="checkbox" id="chk-heatmap"> Heatmap</label>
      <label><input type="checkbox" id="chk-flame"> Timeline</label>
      <label><input type="checkbox" id="chk-cache"> Page Cache</label>
      <label>Fade: <input type="range" id="fade-slider" min="200" max="8000" value="2000" step="100"> <span class="fade-val" id="fade-val">2.0s</span></label>
      <label>Trail W: <input type="range" id="trail-width" min="0.5" max="6" value="1.0" step="0.5"> <span class="fade-val" id="trail-w-val">1.0</span></label>
    </div>
  </div>
  <div class="status-bar">
    <span><span class="dot connecting" id="ws-dot"></span><span id="ws-status">Connecting</span></span>
    <span class="stat-label">Events/s: <span class="stat-value" id="evt-rate">0</span></span>
    <span class="stat-label">Total: <span class="stat-value" id="evt-total">0</span></span>
    <span class="stat-label">Active: <span class="stat-value" id="active-count">0</span></span>
    <span class="stat-label">FPS: <span class="stat-value" id="fps-counter">-</span></span>
  </div>
  <div class="status-bar">
    <span class="stat-label" style="color:#3c82f6">R: <span class="stat-value" id="cnt-read">0</span></span>
    <span class="stat-label" style="color:#ef4444">W: <span class="stat-value" id="cnt-write">0</span></span>
    <span class="stat-label" style="color:#eab308">F: <span class="stat-value" id="cnt-free">0</span></span>
    <span class="stat-label">Latest: <span class="stat-value" id="evt-latest">-</span></span>
    <span id="lag-warn" style="display:none;color:#f87171;font-weight:600">&#9888; Lagged <span id="lag-count">0</span> msgs</span>
  </div>
  <div class="controls">
    <button id="btn-zin">Zoom +</button>
    <button id="btn-zout">Zoom &minus;</button>
    <button id="btn-reset">Reset</button>
    <button id="btn-clear">Clear Highlights</button>
    <span class="zoom-info" id="zoom-info"></span>
  </div>
  <div id="canvas-wrap">
    <div id="loading"><span id="load-text">Loading page map&hellip;</span><div id="load-bar-wrap"><div id="load-bar"></div></div></div>
    <canvas id="map" style="display:none"></canvas>
  </div>
  <div id="flame-wrap" style="height:0;overflow:hidden;transition:height 0.2s">
    <canvas id="flame"></canvas>
  </div>
</div>
<div id="side-panel">
  <h2>Blocks <span id="block-live" style="color:#4ade80" onclick="window._goLive&&window._goLive()">&#x25CF; LIVE</span></h2>
  <div id="block-panel" style="max-height:172px;overflow-y:auto"></div>
  <h2 style="margin-top:12px">Tables <span id="cache-total" style="color:#8b949e;font-weight:400;font-size:11px"></span> <span id="cache-ago" style="color:#8b949e;font-weight:400;font-size:10px"></span></h2>
  <div id="unified-tables"></div>
  <h2 style="margin-top:12px">Table Details</h2>
  <table><thead><tr><th></th><th>Table</th><th>Pages</th><th>Size</th><th>%</th></tr></thead><tbody id="tbl-body"></tbody></table>
  <h2 style="margin-top:12px">B-Tree Structure</h2>
  <div id="tree-info"></div>
</div>
<div id="tooltip">
  <div class="tt-row"><div class="tt-swatch" id="tt-swatch"></div><div class="tt-name" id="tt-name"></div></div>
  <div class="tt-detail" id="tt-detail"></div>
</div>
<script>
(function(){
"use strict";
function hsl2r(h,s,l){h/=360;s/=100;l/=100;let r,g,b;if(!s){r=g=b=l}else{const q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;const f=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<.5)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};r=f(p,q,h+1/3);g=f(p,q,h);b=f(p,q,h-1/3)}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)]}
const DBI_HUES=new Float32Array(256);
for(let i=2;i<254;i++)DBI_HUES[i]=((i-2)*137.508)%360;
const PAL=new Array(256),PAL_DESAT=new Array(256),PAL_DARK=new Array(256),PAL_DD=new Array(256);
PAL[0]=hsl2r(220,15,82);PAL_DESAT[0]=hsl2r(220,5,72);PAL_DARK[0]=hsl2r(220,15,28);PAL_DD[0]=hsl2r(220,5,22);
PAL[1]=hsl2r(220,30,24);PAL_DESAT[1]=hsl2r(220,8,22);PAL_DARK[1]=hsl2r(220,30,12);PAL_DD[1]=hsl2r(220,8,12);
for(let i=2;i<254;i++){const h=DBI_HUES[i];PAL[i]=hsl2r(h,70,55);PAL_DESAT[i]=hsl2r(h,15,50);PAL_DARK[i]=hsl2r(h,70,22);PAL_DD[i]=hsl2r(h,15,20)}
PAL[0xFE]=[20,20,23];PAL_DESAT[0xFE]=[20,20,23];PAL_DARK[0xFE]=[12,12,14];PAL_DD[0xFE]=[12,12,14];
PAL[0xFF]=[28,28,32];PAL_DESAT[0xFF]=[28,28,32];PAL_DARK[0xFF]=[16,16,18];PAL_DD[0xFF]=[16,16,18];
const FLASH_TINT={1:[140,180,255],2:[255,140,140],3:[255,220,100]};
let NP=0,PS=4096,GC=0,GR=0,DBIS=[],DBI_IDX={},oMap=null,lOp=null,lTs=null,FADE=2000;
let cntR=0,cntW=0,cntF=0;
let sR=true,sW=true,sF=true,fW=false,showTrails=true,trailW=1.0;
const TRAIL_CAP=4096;let trailBuf=new Array(TRAIL_CAP);let trailStart=0,trailN=0;
const TRC={1:"60,130,246",2:"255,80,80",3:"234,179,8"};
let activePgs=0;
const activeSet=new Set();
let oMapDirty=false;
let unrefCount=0;
let outR=0,outG=0,outB=0;
let cacheTotalCached=0,cacheCachedPer=null,cachePrevPer=null,cachePrevTotal=0,cacheStale=true;
let hmMode=false,hmCounts=null;
let cacheMode=false,resMap=null,faultCounts={},faultWindow=[],faultCurrent={};
let cacheLastUpdate=0;
let zbCv=null,zbCx=null,zbDirty=true,zbW=0,zbH=0,zbPX=0,zbPY=0,zbSc=0,zbFlt=false;
const BASE_LUT=new Uint32Array(256*32*2);
function buildLUT(){
  for(let dbi=0;dbi<256;dbi++){for(let hq=0;hq<32;hq++){const ht=hq/31;for(let c=0;c<2;c++){
    let cf,cd;
    if(c){cf=PAL[dbi];cd=PAL_DESAT[dbi]}else{cf=PAL_DARK[dbi];cd=PAL_DD[dbi]}
    if(!cf)cf=PAL[255];if(!cd)cd=PAL_DESAT[255];
    const r=Math.round(cd[0]+(cf[0]-cd[0])*ht);
    const g=Math.round(cd[1]+(cf[1]-cd[1])*ht);
    const b=Math.round(cd[2]+(cf[2]-cd[2])*ht);
    BASE_LUT[(dbi*32+hq)*2+c]=(255<<24)|(b<<16)|(g<<8)|r;
  }}}
}
buildLUT();
function heatQ(pg){if(!hmMode||!hmCounts)return 31;const cnt=hmCounts[pg];return cnt>0?Math.min(31,Math.floor(Math.log2(cnt+1)*31/16)):0}
function rollingFaults(dbi){let s=0;for(const w of faultWindow)s+=(w[dbi]||0);return s}
function markZbDirty(){zbDirty=true}
let blockRecording=null,blockHistory=[],replayMode=false,replayBlockRef=null,replayTimer=null,liveSnapshot=null;
const BLOCK_HISTORY_CAP=15;
let blockPanelDirty=false;
let showFlame=false;const FLAME_SECS=120;let flameData={},flameHead=0;
const SPARK_SECS=60;let sparkData={},sparkAccum={};
const cv=document.getElementById("map"),cx=cv.getContext("2d"),wr=document.getElementById("canvas-wrap");
const ldEl=document.getElementById("loading"),zmEl=document.getElementById("zoom-info");
const tt=document.getElementById("tooltip"),ttSw=document.getElementById("tt-swatch");
const ttNm=document.getElementById("tt-name"),ttDt=document.getElementById("tt-detail");
const tb=document.getElementById("tbl-body");
let W=0,H=0,iD=null,oC=null,oCx=null,pX=0,pY=0,sc=1,mS=.01;const xS=128;
const sel=new Set();let tEv=0,rEv=0,lRT=performance.now();
function cl(v,a,b){return Math.max(a,Math.min(b,v))}
function growTo(newNP){
  if(newNP<=NP)return;
  const oldNP=NP;
  const nOm=new Uint8Array(newNP);nOm.set(oMap);nOm.fill(0xFF,oldNP);oMap=nOm;
  const nOp=new Uint8Array(newNP);nOp.set(lOp);lOp=nOp;
  const nTs=new Float64Array(newNP);nTs.set(lTs);lTs=nTs;
  if(hmCounts){const nHm=new Uint32Array(newNP);nHm.set(hmCounts);hmCounts=nHm}
  if(resMap){const nRm=new Uint8Array(newNP);nRm.set(resMap);resMap=nRm}
  unrefCount+=newNP-oldNP;
  NP=newNP;GR=Math.ceil(NP/GC);
  oMapDirty=true;
  iD=null;oC=null;markZbDirty();
}
function oX(){return 0}
function oY(){return Math.max(0,(H-GR*sc)/2)}
function cP(){const vw=W/sc,vh=H/sc;pX=cl(pX,0,Math.max(0,GC-vw));pY=cl(pY,0,Math.max(0,GR-vh))}
function s2w(sx,sy){return{wx:pX+(sx-oX())/sc,wy:pY+(sy-oY())/sc}}
function w2p(wx,wy){const px=Math.floor(wx),py=Math.floor(wy);if(px<0||py<0||px>=GC||py>=GR)return-1;const i=py*GC+px;return i<NP?i:-1}

function trailPush(from,to,op,ts){
  const idx=(trailStart+trailN)%TRAIL_CAP;
  if(!trailBuf[idx])trailBuf[idx]={from,to,op,ts};
  else{trailBuf[idx].from=from;trailBuf[idx].to=to;trailBuf[idx].op=op;trailBuf[idx].ts=ts}
  if(trailN<TRAIL_CAP)trailN++;
  else trailStart=(trailStart+1)%TRAIL_CAP;
}
function trailExpire(now){
  while(trailN>0){
    const t=trailBuf[trailStart];
    if(now-t.ts>=FADE){trailStart=(trailStart+1)%TRAIL_CAP;trailN--}
    else break;
  }
}
function pCBase(pg,flt){
  if(pg<0||pg>=NP)return false;
  const ow=oMap[pg];
  if(flt&&!sel.has(ow)){outR=25;outG=25;outB=28;return true}
  const hq=heatQ(pg);
  const cached=(cacheMode&&resMap&&pg<resMap.length)?resMap[pg]?1:0:1;
  const rgba=BASE_LUT[(ow*32+hq)*2+cached];
  outR=rgba&0xFF;outG=(rgba>>8)&0xFF;outB=(rgba>>16)&0xFF;
  return true;
}
function pC(pg,flt,now){
  if(!pCBase(pg,flt))return false;
  const op=lOp[pg];
  if(op&&((op===1&&sR)||(op===2&&sW)||(op===3&&sF))){
    const age=now-lTs[pg];
    if(age>=FADE){lOp[pg]=0;activePgs=Math.max(0,activePgs-1);activeSet.delete(pg)}
    else{const a2=Math.max(0,age);const t=1-(a2/FADE)*(a2/FADE);const fl=FLASH_TINT[op];const fi=t*0.7;
      outR=Math.min(255,Math.round(outR+(fl[0]-outR)*fi));
      outG=Math.min(255,Math.round(outG+(fl[1]-outG)*fi));
      outB=Math.min(255,Math.round(outB+(fl[2]-outB)*fi))}
  }
  return true;
}
function pg2s(pg){const col=pg%GC,row=Math.floor(pg/GC);return{sx:oX()+(col-pX+.5)*sc,sy:oY()+(row-pY+.5)*sc}}
function drawTrails(now){
  if(!showTrails||trailN===0)return;
  cx.lineCap="round";cx.lineWidth=trailW;
  const paths={1:[],2:[],3:[]};
  for(let j=0;j<trailN;j++){
    const idx=(trailStart+j)%TRAIL_CAP;
    const t=trailBuf[idx];
    const age=now-t.ts;if(age>=FADE)continue;
    if((t.op===1&&!sR)||(t.op===2&&!sW)||(t.op===3&&!sF))continue;
    const a=1-Math.pow(age/FADE,2);
    const f=pg2s(t.from),e=pg2s(t.to);
    (paths[t.op]||(paths[t.op]=[])).push({fx:f.sx,fy:f.sy,ex:e.sx,ey:e.sy,a});
  }
  for(const op of [1,2,3]){
    const segs=paths[op];if(!segs||!segs.length)continue;
    const groups={};
    for(const s of segs){
      const ak=Math.round(s.a*10);
      if(!groups[ak])groups[ak]=[];
      groups[ak].push(s);
    }
    const c=TRC[op]||TRC[1];
    for(const [ak,gs] of Object.entries(groups)){
      cx.strokeStyle=`rgba(${c},${(ak/10*0.6).toFixed(2)})`;
      cx.beginPath();
      for(const s of gs){cx.moveTo(s.fx,s.fy);cx.lineTo(s.ex,s.ey)}
      cx.stroke();
    }
  }
}
function rebuildZoomBase(flt){
  if(!zbCv){zbCv=document.createElement("canvas");zbCx=zbCv.getContext("2d")}
  zbCv.width=W;zbCv.height=H;zbW=W;zbH=H;zbPX=pX;zbPY=pY;zbSc=sc;zbFlt=flt;
  const zd=zbCx.createImageData(W,H),d=zd.data,ox=oX(),oy=oY(),ips=1/sc;
  for(let sy=0;sy<H;sy++){
    const wy0=Math.max(0,Math.floor(pY+(sy-oy)*ips)),wy1=Math.min(GR-1,Math.floor(pY+(sy-oy+1)*ips));
    for(let sx=0;sx<W;sx++){
      const wx0=Math.max(0,Math.floor(pX+(sx-ox)*ips)),wx1=Math.min(GC-1,Math.floor(pX+(sx-ox+1)*ips));
      const o=(sy*W+sx)<<2;
      if(wx1<0||wy1<0||wx0>=GC||wy0>=GR){d[o]=0;d[o+1]=0;d[o+2]=0;d[o+3]=255;continue}
      const cpx=Math.floor((wx0+wx1)/2),cpy=Math.floor((wy0+wy1)/2);
      const ci=cpy*GC+cpx;
      if(ci>=0&&ci<NP&&pCBase(ci,flt)){d[o]=outR;d[o+1]=outG;d[o+2]=outB}
      d[o+3]=255;
    }
  }
  zbCx.putImageData(zd,0,0);
}
function drawActiveOverlay(now,flt){
  if(activeSet.size===0)return;
  const ox=oX(),oy=oY(),ips=1/sc;
  const expired=[];
  for(const pg of activeSet){
    const op=lOp[pg];
    if(!op){expired.push(pg);continue}
    if((op===1&&!sR)||(op===2&&!sW)||(op===3&&!sF))continue;
    const age=now-lTs[pg];
    if(age>=FADE){lOp[pg]=0;activePgs=Math.max(0,activePgs-1);expired.push(pg);continue}
    pCBase(pg,flt);
    const a2=Math.max(0,age);const t=1-(a2/FADE)*(a2/FADE);const fl=FLASH_TINT[op];const fi=t*0.7;
    const r=Math.min(255,Math.round(outR+(fl[0]-outR)*fi));
    const g=Math.min(255,Math.round(outG+(fl[1]-outG)*fi));
    const b=Math.min(255,Math.round(outB+(fl[2]-outB)*fi));
    const col=pg%GC,row=Math.floor(pg/GC);
    const sx=ox+(col-pX)*sc,sy=oy+(row-pY)*sc;
    if(sx<-sc||sy<-sc||sx>W||sy>H)continue;
    const psz=Math.max(1,Math.ceil(sc));
    cx.fillStyle=`rgb(${r},${g},${b})`;
    cx.fillRect(Math.floor(sx),Math.floor(sy),psz,psz);
  }
  for(const pg of expired)activeSet.delete(pg);
}
function render(){
  if(!oMap||W<1||H<1)return;
  const flt=sel.size>0,now=performance.now();
  if(sc>=1){
    const vw=W/sc,vh=H/sc,x0=Math.floor(pX),y0=Math.floor(pY);
    const x1=Math.min(GC,Math.ceil(pX+vw)+1),y1=Math.min(GR,Math.ceil(pY+vh)+1);
    const vW=Math.max(1,x1-x0),vH=Math.max(1,y1-y0);
    if(!oC){oC=document.createElement("canvas");oCx=oC.getContext("2d")}
    if(oC.width!==vW||oC.height!==vH){oC.width=vW;oC.height=vH}
    const od=oCx.createImageData(vW,vH),d=od.data;
    for(let y=0;y<vH;y++){const gy=y0+y;for(let x=0;x<vW;x++){
      const i=gy*GC+(x0+x),o=(y*vW+x)<<2;
      const ok=(i>=0&&i<NP)?pC(i,flt,now):false;
      if(ok){d[o]=outR;d[o+1]=outG;d[o+2]=outB}else{d[o]=0;d[o+1]=0;d[o+2]=0}d[o+3]=255;
    }}
    oCx.putImageData(od,0,0);cx.imageSmoothingEnabled=false;cx.clearRect(0,0,W,H);
    cx.drawImage(oC,oX()-(pX-x0)*sc,oY()-(pY-y0)*sc,vW*sc,vH*sc);
    drawTrails(now);
    zmEl.textContent=sc.toFixed(sc>=10?0:1)+" px/page";
  }else{
    if(zbDirty||!zbCv||zbW!==W||zbH!==H||zbPX!==pX||zbPY!==pY||zbSc!==sc||zbFlt!==flt){
      rebuildZoomBase(flt);zbDirty=false;
    }
    cx.clearRect(0,0,W,H);
    cx.drawImage(zbCv,0,0);
    drawActiveOverlay(now,flt);
    drawTrails(now);
    const pp=1/sc;zmEl.textContent="1 px = "+pp.toFixed(pp>=10?0:1)+" pages";
  }
}
let anim=false;
let fpsFrames=0,fpsLast=performance.now();
function rLoop(){
  render();let act=0;const now=performance.now();
  act+=activePgs;
  if(showTrails){trailExpire(now);act+=trailN}
  document.getElementById("active-count").textContent=act.toLocaleString();
  fpsFrames++;
  const fpsNow=performance.now();
  if(fpsNow-fpsLast>=500){
    document.getElementById("fps-counter").textContent=Math.round(fpsFrames/((fpsNow-fpsLast)/1000));
    fpsFrames=0;fpsLast=fpsNow;
  }
  if(act>0&&!(replayMode&&!replayTimer))requestAnimationFrame(rLoop);else{anim=false;document.getElementById("fps-counter").textContent="-"}
}
function kick(){if(!anim){anim=true;requestAnimationFrame(rLoop)}}
let schedPending=false;
function sched(){if(!schedPending){schedPending=true;requestAnimationFrame(()=>{schedPending=false;render()})}}
function szCv(){const w=wr.clientWidth,h=wr.clientHeight;if(w<1||h<1)return;W=w;H=h;cv.width=W;cv.height=H;iD=null}
function fmtSz(mb){if(mb>=1024)return(mb/1024).toFixed(1)+" GB";if(mb>=1)return mb.toFixed(1)+" MB";return(mb*1024).toFixed(0)+" KB"}
function bldTbl(){
  tb.innerHTML="";const mx=Math.max(...DBIS.map(d=>d.pct),.1);
  DBIS.forEach(d=>{const tr=document.createElement("tr");tr.className="tbl-row";tr.dataset.dbiIndex=d.dbi_index;
    const c=PAL[d.dbi_index]||PAL[255];
    tr.innerHTML=`<td><div class="swatch-cell" style="background:rgb(${c[0]},${c[1]},${c[2]})"></div></td><td>${d.name}</td><td>${d.pages.toLocaleString()}</td><td>${fmtSz(d.size_mb)}</td><td><span class="pct-bar" style="width:${d.pct/mx*60}px;background:rgb(${c[0]},${c[1]},${c[2]})"></span>${d.pct}%</td>`;
    tr.addEventListener("click",()=>{const i=d.dbi_index;if(sel.has(i))sel.delete(i);else sel.add(i);uAR();markZbDirty();sched()});
    tb.appendChild(tr);
  });
}
function uAR(){document.querySelectorAll(".tbl-row").forEach(r=>{sel.has(parseInt(r.dataset.dbiIndex,10))?r.classList.add("active"):r.classList.remove("active")});document.querySelectorAll(".utbl-row").forEach(r=>{sel.has(parseInt(r.dataset.dbiIndex,10))?r.classList.add("active"):r.classList.remove("active")})}
function reflow(){if(!fW)return;GC=Math.max(1,Math.floor(W/sc));GR=Math.ceil(NP/GC);pX=0;cP()}
function boot(){szCv();const aspect=W>0&&H>0?W/H:1;GC=Math.max(1,Math.ceil(Math.sqrt(NP*aspect)));GR=Math.ceil(NP/GC);mS=Math.min(W/GC,H/GR,1);sc=mS;pX=0;pY=0;render()}
function zA(ns,sx,sy){ns=cl(ns,mS,xS);if(Math.abs(ns-sc)<1e-6)return;const b=s2w(sx,sy);sc=ns;if(fW){reflow();pY=b.wy-(sy-oY())/sc;cP()}else{pX=b.wx-(sx-oX())/sc;pY=b.wy-(sy-oY())/sc;cP()}sched()}
document.getElementById("btn-zin").addEventListener("click",()=>zA(sc*1.3,W>>1,H>>1));
document.getElementById("btn-zout").addEventListener("click",()=>zA(sc/1.3,W>>1,H>>1));
document.getElementById("btn-reset").addEventListener("click",()=>{sc=mS;pX=0;pY=0;sel.clear();uAR();markZbDirty();render()});
document.getElementById("btn-clear").addEventListener("click",()=>{if(lOp)lOp.fill(0);if(hmCounts)hmCounts.fill(0);activePgs=0;activeSet.clear();markZbDirty();sched()});
wr.addEventListener("wheel",e=>{e.preventDefault();const r=cv.getBoundingClientRect();zA(sc*Math.exp(-(e.deltaMode===1?e.deltaY*16:e.deltaY)*.002),(e.clientX-r.left)/r.width*W,(e.clientY-r.top)/r.height*H)},{passive:false});
let drag=false,lCX=0,lCY=0;
cv.addEventListener("pointerdown",e=>{drag=true;lCX=e.clientX;lCY=e.clientY;cv.setPointerCapture(e.pointerId);cv.style.cursor="grabbing"});
cv.addEventListener("pointermove",e=>{
  if(drag){if(!fW)pX-=(e.clientX-lCX)/sc;pY-=(e.clientY-lCY)/sc;lCX=e.clientX;lCY=e.clientY;cP();sched();tt.style.display="none";return}
  const r=cv.getBoundingClientRect(),sx=(e.clientX-r.left)/r.width*W,sy=(e.clientY-r.top)/r.height*H;
  const w=s2w(sx,sy),pg=w2p(w.wx,w.wy);if(pg<0){tt.style.display="none";return}
  const ow=oMap[pg],inf=DBI_IDX[ow],c=PAL[ow]||PAL[255];
  ttSw.style.background=`rgb(${c[0]},${c[1]},${c[2]})`;
  let ex="";const op=lOp[pg];if(op===1)ex=" [READ]";else if(op===2)ex=" [WRITE]";else if(op===3)ex=" [FREE]";
  ttNm.textContent=`Page ${pg.toLocaleString()} \u2014 ${inf?inf.name:"idx "+ow}${ex}`;
  let dtxt=inf?`${inf.pages.toLocaleString()} pages, ${inf.pct}%`:"";
  if(hmCounts&&pg<hmCounts.length&&hmCounts[pg]>0)dtxt+=(dtxt?" \u00b7 ":"")+hmCounts[pg].toLocaleString()+" hits";
  if(resMap&&pg<resMap.length){
    const cached=resMap[pg];
    dtxt+=(dtxt?" \u00b7 ":"")+(cached?'<span style="color:#28c840;font-weight:600">CACHED</span>':'<span style="color:#f04040;font-weight:600">NOT CACHED</span>');
  }
  ttDt.innerHTML=dtxt;
  tt.style.display="block";tt.style.left=(e.clientX+14)+"px";tt.style.top=(e.clientY+14)+"px";
});
cv.addEventListener("pointerup",()=>{drag=false;cv.style.cursor="crosshair"});
cv.addEventListener("pointercancel",()=>{drag=false;cv.style.cursor="crosshair"});
cv.addEventListener("mouseleave",()=>{tt.style.display="none"});
document.getElementById("chk-read").addEventListener("change",e=>{sR=e.target.checked;sched()});
document.getElementById("chk-write").addEventListener("change",e=>{sW=e.target.checked;sched()});
document.getElementById("chk-free").addEventListener("change",e=>{sF=e.target.checked;sched()});
document.getElementById("fade-slider").addEventListener("input",e=>{FADE=parseInt(e.target.value);document.getElementById("fade-val").textContent=(FADE/1000).toFixed(1)+"s"});
document.getElementById("chk-trails").addEventListener("change",e=>{showTrails=e.target.checked;if(!showTrails){trailStart=0;trailN=0}sched()});
document.getElementById("trail-width").addEventListener("input",e=>{trailW=parseFloat(e.target.value);document.getElementById("trail-w-val").textContent=trailW.toFixed(1);sched()});
document.getElementById("chk-heatmap").addEventListener("change",e=>{hmMode=e.target.checked;markZbDirty();sched()});
document.getElementById("chk-cache").addEventListener("change",e=>{cacheMode=e.target.checked;markZbDirty();sched()});
document.getElementById("chk-flame").addEventListener("change",e=>{
  showFlame=e.target.checked;const fw=document.getElementById("flame-wrap");
  const at=DBIS.filter(d=>d.pages>0);fw.style.height=showFlame?Math.min(at.length*8+24,200)+"px":"0";
  if(showFlame){szFlame();drawFlame()}
});
document.getElementById("chk-fixw").addEventListener("change",e=>{fW=e.target.checked;if(fW){reflow()}else{GC=Math.ceil(Math.sqrt(NP));GR=Math.ceil(NP/GC);mS=Math.min(W/GC,H/GR,1);pX=0;cP()}sched()});
window.addEventListener("resize",()=>{if(!oMap)return;szCv();reflow();mS=Math.min(W/GC,H/GR,1);if(sc<mS)sc=mS;cP();render();if(showFlame){szFlame();drawFlame()}});
const wD=document.getElementById("ws-dot"),wS=document.getElementById("ws-status");
function connectWS(){
  const ws=new WebSocket(`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/ws`);
  ws.binaryType="arraybuffer";
  ws.onopen=()=>{wD.className="dot connected";wS.textContent="Connected"};
  ws.onclose=()=>{wD.className="dot disconnected";wS.textContent="Reconnecting...";setTimeout(connectWS,1000)};
  ws.onerror=()=>ws.close();
  let lagTimer=0;
  ws.onmessage=msg=>{
    if(typeof msg.data==="string"){try{const j=JSON.parse(msg.data);if(j.lagged){const el=document.getElementById("lag-warn"),lc=document.getElementById("lag-count");lc.textContent=j.lagged.toLocaleString();el.style.display="inline";clearTimeout(lagTimer);lagTimer=setTimeout(()=>{el.style.display="none"},5000)}}catch(e){}return}
    if(!oMap)return;const v=new DataView(msg.data);const now=performance.now();let cnt=0;
    let lastPg=-1,lastDbi=0,lastOp=0,prevPg=-1;
    {let scan=0,maxPg=NP;while(scan+8<=msg.data.byteLength){const pg=v.getUint32(scan,true),op=v.getUint8(scan+6);scan+=8;if(op>=4)continue;if(pg>=maxPg)maxPg=pg+1}if(maxPg>NP)growTo(maxPg)}
    let off=0;
    while(off+8<=msg.data.byteLength){
      const pg=v.getUint32(off,true),dbi=v.getUint16(off+4,true),op=v.getUint8(off+6),rsv=v.getUint8(off+7);off+=8;
      if(op===4){if(!replayMode){blockRecording={number:pg,events:[],before:{},faults:0,startTime:performance.now()};blockPanelDirty=true}continue}
      if(op===5){
        if(!replayMode&&blockRecording&&blockRecording.number===pg){
          const txCount=dbi&0xFF,gasEnc=(dbi>>8)&0xFF;
          blockRecording.txCount=txCount;
          blockRecording.duration=rsv>0?Math.pow(2,rsv/20.0):0;
          blockRecording.gasUsed=gasEnc>0?Math.pow(2,gasEnc/10.0):0;
          let r=0,w=0,f=0;
          for(const e of blockRecording.events){if(e.op===1)r++;else if(e.op===2)w++;else if(e.op===3)f++}
          blockRecording.reads=r;blockRecording.writes=w;blockRecording.frees=f;
          blockRecording.uniquePages=Object.keys(blockRecording.before).length;
          blockRecording.panelSnapshot={
            dbiPages:DBIS.map(d=>d.pages),
            cacheCachedPer:cacheCachedPer?cacheCachedPer.slice():null,
            cachePrevPer:cachePrevPer?cachePrevPer.slice():null,
            cacheTotalCached,cachePrevTotal,unrefCount,
            faultWindow:faultWindow.map(w=>({...w})),
            faultCurrent:{...faultCurrent}
          };
          blockHistory.push(blockRecording);
          if(blockHistory.length>BLOCK_HISTORY_CAP)blockHistory.shift();
          blockRecording=null;
          blockPanelDirty=true;
        }
        continue;
      }
      if(blockRecording){
        if(!(pg in blockRecording.before))blockRecording.before[pg]={om:oMap[pg],rm:resMap?resMap[pg]:0};
        blockRecording.events.push({pg,dbi,op});
      }
      if(pg>=NP)continue;cnt++;
      if(op===1)cntR++;else if(op===2)cntW++;else if(op===3)cntF++;
      if(cacheMode&&resMap&&op===1&&pg<resMap.length&&!resMap[pg]){faultCounts[dbi]=(faultCounts[dbi]||0)+1;faultCurrent[dbi]=(faultCurrent[dbi]||0)+1;if(blockRecording){blockRecording.faults=(blockRecording.faults||0)+1}}
             if(resMap&&pg<resMap.length&&op!==3)resMap[pg]=1;
             if(hmCounts)hmCounts[pg]++;
      if(sparkAccum[dbi]!==undefined)sparkAccum[dbi]++;
      if(op===2&&dbi>0&&dbi<0xFE){const old=oMap[pg];if(old!==dbi){oMap[pg]=dbi;oMapDirty=true;
        const di=DBI_IDX[dbi];if(di)di.pages++;
        const oi=DBI_IDX[old];if(oi&&oi.pages>0)oi.pages--;
        if(old===0xFF)unrefCount--;
      }}
      if(op===3){const old=oMap[pg];if(old!==1){oMap[pg]=1;oMapDirty=true;
        const di=DBI_IDX[1];if(di)di.pages++;
        const oi=DBI_IDX[old];if(oi&&oi.pages>0)oi.pages--;
        if(old===0xFF)unrefCount--;
      }}
      if(replayMode)continue;
      const prev=lOp[pg],prevLive=prev&&(now-lTs[pg])<FADE;
      if(!prevLive||op>=prev){
        if(prev===0)activePgs++;
        lOp[pg]=op;lTs[pg]=now;
        activeSet.add(pg);
      }
      if(showTrails&&prevPg>=0&&prevPg!==pg&&!((op===1&&!sR)||(op===2&&!sW)||(op===3&&!sF)))trailPush(prevPg,pg,op,now);
      prevPg=pg;
      if(op>=2){lastPg=pg;lastDbi=dbi;lastOp=op}else if(lastPg<0){lastPg=pg;lastDbi=dbi;lastOp=op}
    }
    tEv+=cnt;rEv+=cnt;document.getElementById("evt-total").textContent=tEv.toLocaleString();
    document.getElementById("cnt-read").textContent=cntR.toLocaleString();
    document.getElementById("cnt-write").textContent=cntW.toLocaleString();
    document.getElementById("cnt-free").textContent=cntF.toLocaleString();
    if(lastPg>=0){const inf=DBI_IDX[lastDbi];const nm=inf?inf.name:"dbi"+lastDbi;const opN=lastOp===1?"R":lastOp===2?"W":"F";document.getElementById("evt-latest").textContent=opN+" pg"+lastPg.toLocaleString()+" "+nm}
    const el=now-lRT;if(el>=1000){document.getElementById("evt-rate").textContent=Math.round(rEv/(el/1000)).toLocaleString();rEv=0;lRT=now}
    if(cnt>0&&!replayMode)kick();
  };
}
function szFlame(){
  const fw=document.getElementById("flame-wrap"),fc=document.getElementById("flame");
  if(!fw||!fc)return;fc.width=fw.clientWidth||300;fc.height=fw.clientHeight||100;
}
function drawFlame(){
  const fc=document.getElementById("flame");if(!fc)return;
  const ctx=fc.getContext("2d"),cw=fc.width,ch=fc.height;ctx.clearRect(0,0,cw,ch);
  const at=DBIS.filter(d=>d.pages>0);if(!at.length)return;
  const lw=42,rw=cw-lw,rowH=Math.max(4,Math.floor((ch-14)/Math.max(1,at.length)));
  ctx.font="7px monospace";
  for(let r=0;r<at.length;r++){
    const d=at[r],fd=flameData[d.dbi_index];if(!fd)continue;
    const c=PAL[d.dbi_index]||PAL[255],y=r*rowH;
    let mx=1;for(let s=0;s<FLAME_SECS;s++){const v=fd[s];if(v>mx)mx=v}
    for(let s=0;s<FLAME_SECS;s++){
      const idx=((flameHead-FLAME_SECS+s)%FLAME_SECS+FLAME_SECS)%FLAME_SECS;
      const ops=fd[idx];if(ops<=0)continue;
      const x=lw+(s/FLAME_SECS)*rw,w=Math.ceil(rw/FLAME_SECS);
      const a=Math.min(1,Math.log2(ops+1)/Math.log2(mx+1));
      ctx.fillStyle=`rgba(${c[0]},${c[1]},${c[2]},${a.toFixed(2)})`;
      ctx.fillRect(x,y,w,rowH-1);
    }
    ctx.fillStyle="#8b949e";ctx.fillText(d.name.slice(0,6),2,y+rowH-2);
  }
  const ay=at.length*rowH+2;ctx.fillStyle="#30363d";ctx.fillRect(lw,ay,rw,1);
  ctx.fillStyle="#8b949e";ctx.font="7px monospace";
  for(let s=30;s<FLAME_SECS;s+=30){
    const x=lw+((FLAME_SECS-s)/FLAME_SECS)*rw;
    ctx.fillText("-"+s+"s",x,ay+10);
  }
}
function buildUnifiedPanel(){
  const el=document.getElementById("unified-tables");if(!el)return;el.innerHTML="";
  const hdr=document.createElement("div");hdr.className="utbl-row";hdr.style.cssText="cursor:default;border-bottom:1px solid #30363d;margin-bottom:2px;padding-bottom:4px";
  hdr.innerHTML='<div class="utbl-sw" style="visibility:hidden"></div><div class="utbl-name" style="color:#8b949e;font-weight:500;text-transform:uppercase;font-size:9px">Table</div><div class="utbl-spark" style="width:80px;text-align:center;color:#8b949e;font-weight:500;text-transform:uppercase;font-size:9px">Activity</div><div class="utbl-cache" style="color:#8b949e;font-weight:500;text-transform:uppercase;font-size:9px;text-align:center">Cache</div><div class="utbl-diff" style="color:#8b949e;font-weight:500;text-transform:uppercase;font-size:9px">Diff</div><div class="utbl-faults" style="color:#8b949e;font-weight:500;text-transform:uppercase;font-size:9px" title="Page faults over last 3 residency updates">Fault<span style="font-size:7px;text-transform:none"> (3)</span></div>';
  el.appendChild(hdr);
  DBIS.forEach(d=>{
    if(d.pages<=0&&d.dbi_index>2)return;
    const c=PAL[d.dbi_index]||PAL[255];
    const row=document.createElement("div");row.className="utbl-row";
    row.dataset.dbiIndex=d.dbi_index;
    const sw=document.createElement("div");sw.className="utbl-sw";
    sw.style.background=`rgb(${c[0]},${c[1]},${c[2]})`;
    const nm=document.createElement("div");nm.className="utbl-name";nm.textContent=d.name;
    const cv=document.createElement("canvas");cv.className="utbl-spark";cv.width=80;cv.height=16;
    cv.style.cssText="width:80px;height:16px;border:1px solid #21262d;border-radius:2px;background:#0d1117";
    const cp=document.createElement("div");cp.className="utbl-cache";
    const cpBar=document.createElement("div");cpBar.className="utbl-cache-bar-wrap";
    const cpFill=document.createElement("div");cpFill.className="utbl-cache-fill";cpFill.style.width="0%";cpFill.style.background=`rgb(${c[0]},${c[1]},${c[2]})`;
    cpBar.appendChild(cpFill);
    const cpPct=document.createElement("div");cpPct.className="utbl-cache-pct";
    cp.append(cpBar,cpPct);
    const cd=document.createElement("div");cd.className="utbl-diff";
    const ft=document.createElement("div");ft.className="utbl-faults";
    row.append(sw,nm,cv,cp,cd,ft);
    row.addEventListener("click",()=>{const i=d.dbi_index;if(sel.has(i))sel.delete(i);else sel.add(i);uAR();markZbDirty();sched()});
    el.appendChild(row);
    d._sparkCv=cv;d._sparkCtx=cv.getContext("2d");
    d._cacheEl=cp;d._cacheFill=cpFill;d._cachePct=cpPct;d._diffEl=cd;d._faultEl=ft;
  });
}
function drawSparkline(d){
  const cv=d._sparkCv,ctx=d._sparkCtx;if(!cv||!ctx)return;
  const sd=sparkData[d.dbi_index];if(!sd)return;
  const w=cv.width,h=cv.height,c=PAL[d.dbi_index]||PAL[255];
  ctx.clearRect(0,0,w,h);
  let mx=1;for(let i=0;i<SPARK_SECS;i++){const v=sd.ring[i];if(v>mx)mx=v}
  const latest=sd.ring[((sd.head-1)%SPARK_SECS+SPARK_SECS)%SPARK_SECS];
  ctx.beginPath();ctx.moveTo(0,h);
  for(let i=0;i<SPARK_SECS;i++){
    const idx=((sd.head-SPARK_SECS+i)%SPARK_SECS+SPARK_SECS)%SPARK_SECS;
    const x=(i/(SPARK_SECS-1))*w,y=h-(sd.ring[idx]/mx)*h;
    if(i===0)ctx.lineTo(x,y);else ctx.lineTo(x,y);
  }
  ctx.lineTo(w,h);ctx.closePath();
  ctx.fillStyle=`rgba(${c[0]},${c[1]},${c[2]},0.3)`;ctx.fill();
  ctx.beginPath();
  for(let i=0;i<SPARK_SECS;i++){
    const idx=((sd.head-SPARK_SECS+i)%SPARK_SECS+SPARK_SECS)%SPARK_SECS;
    const x=(i/(SPARK_SECS-1))*w,y=h-(sd.ring[idx]/mx)*h;
    if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
  }
  ctx.strokeStyle=`rgba(${c[0]},${c[1]},${c[2]},0.8)`;ctx.lineWidth=1;ctx.stroke();
  if(d._sparkVal)d._sparkVal.textContent=latest.toLocaleString();
}
function buildTreeInfo(info){
  const el=document.getElementById("tree-info");if(!el)return;el.innerHTML="";
  info.forEach(ti=>{
    if(ti.height===0&&ti.branch_pages===0&&ti.leaf_pages===0&&ti.large_pages===0)return;
    const card=document.createElement("div");card.className="tree-card";
    const total=ti.branch_pages+ti.leaf_pages+ti.large_pages;
    const ipl=ti.leaf_pages>0?Math.round(ti.items/ti.leaf_pages):0;
    let html=`<div class="tree-name">${ti.name} <span style="color:#8b949e;font-weight:400">depth ${ti.height}</span></div>`;
    html+=`<div class="tree-stat">B:${ti.branch_pages.toLocaleString()} L:${ti.leaf_pages.toLocaleString()} O:${ti.large_pages.toLocaleString()} items:${ti.items.toLocaleString()}</div>`;
    if(total>0){
      const bp=Math.max(1,Math.round(ti.branch_pages/total*100)),lp=Math.max(1,Math.round(ti.leaf_pages/total*100)),op=Math.max(1,100-bp-lp);
      html+=`<div class="tree-bar"><div class="tree-seg" style="width:${bp}%;background:#3c82f6"></div><div class="tree-seg" style="width:${lp}%;background:#4ade80"></div><div class="tree-seg" style="width:${op}%;background:#f58231"></div></div>`;
    }
    if(ipl>0)html+=`<div class="tree-stat">~${ipl.toLocaleString()} items/leaf</div>`;
    card.innerHTML=html;
    card.addEventListener("click",()=>{const i=ti.dbi_index;if(sel.has(i))sel.delete(i);else sel.add(i);uAR();markZbDirty();sched()});
    el.appendChild(card);
  });
}
function fmtGas(g){if(g>=1e6)return(g/1e6).toFixed(1)+"M";if(g>=1e3)return(g/1e3).toFixed(0)+"K";return g.toFixed(0)}
function updateBlockPanel(){
  blockPanelDirty=false;
  const el=document.getElementById("block-panel");if(!el)return;
  el.innerHTML="";
  if(blockRecording){
    const c=document.createElement("div");c.className="block-card recording";
    const elapsed=performance.now()-blockRecording.startTime;
    const elStr=elapsed<1000?elapsed.toFixed(0)+"ms":(elapsed/1000).toFixed(1)+"s";
    c.innerHTML=`<div class="block-num">&#x23F1; #${blockRecording.number.toLocaleString()} recording\u2026</div><div class="block-stat">${blockRecording.events.length.toLocaleString()} events &nbsp;${elStr}</div>`;
    el.appendChild(c);
  }
  for(let i=blockHistory.length-1;i>=0;i--){
    const b=blockHistory[i],isReplaying=replayMode&&replayBlockRef===b;
    const c=document.createElement("div");c.className="block-card"+(isReplaying?" replaying":"");
    const total=b.reads+b.writes+b.frees;
    const dur=b.duration>0?(b.duration<1000?b.duration.toFixed(0)+"ms":(b.duration/1000).toFixed(1)+"s"):"";
    const gas=b.gasUsed>0?fmtGas(b.gasUsed)+"gas":"";
    c.innerHTML=`<div class="block-num">&#x25B6; #${b.number.toLocaleString()} &nbsp;${b.txCount}tx${dur?" &nbsp;"+dur:""}${gas?" &nbsp;"+gas:""} &nbsp;${total.toLocaleString()} ops</div><div class="block-stat"><span style="color:#3c82f6">R:${b.reads.toLocaleString()}</span> <span style="color:#ef4444">W:${b.writes.toLocaleString()}</span> <span style="color:#eab308">F:${b.frees.toLocaleString()}</span>${b.faults?` <span style="color:#d946ef">${b.faults}f</span>`:""} &nbsp;${(b.uniquePages||0).toLocaleString()} pages</div>`;
    c.addEventListener("click",()=>startReplay(b));
    el.appendChild(c);
  }
}
function snapPanelState(){
  return{dbiPages:DBIS.map(d=>d.pages),cacheCachedPer:cacheCachedPer?cacheCachedPer.slice():null,cachePrevPer:cachePrevPer?cachePrevPer.slice():null,cacheTotalCached,cachePrevTotal,unrefCount,faultWindow:faultWindow.map(w=>({...w})),faultCurrent:{...faultCurrent}};
}
function applyPanelSnap(snap){
  DBIS.forEach((d,i)=>{d.pages=snap.dbiPages[i]||0;d.pct=NP>0?Math.round(d.pages/NP*10000)/100:0;d.size_mb=Math.round(d.pages*PS/(1024*1024)*10)/10});
  if(snap.cacheCachedPer&&cacheCachedPer){for(let i=0;i<cacheCachedPer.length;i++)cacheCachedPer[i]=snap.cacheCachedPer[i]||0}
  cachePrevPer=snap.cachePrevPer?snap.cachePrevPer.slice():null;
  cacheTotalCached=snap.cacheTotalCached;cachePrevTotal=snap.cachePrevTotal;
  unrefCount=snap.unrefCount;
  faultWindow=snap.faultWindow.map(w=>({...w}));faultCurrent={...snap.faultCurrent};
  cacheStale=true;bldTbl();updateCacheStats();
  const rf=NP-unrefCount,gb=(NP*PS/(1024**3)).toFixed(2);
  document.getElementById("subtitle").textContent=`${NP.toLocaleString()} pages \u00b7 ${rf.toLocaleString()} ref \u00b7 ${unrefCount.toLocaleString()} unref \u00b7 ${PS>=1024?(PS/1024)+"K":PS} \u00b7 ${gb} GB \u00b7 ${DBIS.length} tables`;
}
function startReplay(block){
  if(replayMode&&replayBlockRef===block&&replayTimer)return;
  if(!liveSnapshot)liveSnapshot=snapPanelState();
  replayMode=true;replayBlockRef=block;
  if(replayTimer){cancelAnimationFrame(replayTimer);replayTimer=null}
  lOp.fill(0);activeSet.clear();activePgs=0;
  if(hmCounts)hmCounts.fill(0);
  trailStart=0;trailN=0;
  for(const pgStr in block.before){
    const pg=parseInt(pgStr,10);if(pg>=NP)continue;
    const snap=block.before[pg];
    oMap[pg]=snap.om;
    if(resMap&&pg<resMap.length)resMap[pg]=snap.rm;
  }
  if(block.panelSnapshot)applyPanelSnap(block.panelSnapshot);
  markZbDirty();sched();
  document.getElementById("block-live").style.color="#8b949e";
  updateBlockPanel();
  const events=block.events;
  const batchSize=Math.max(1,Math.ceil(events.length/60));
  let idx=0;
  function step(){
    if(!replayMode){replayTimer=null;return}
    const end=Math.min(idx+batchSize,events.length);
    const now=performance.now();
    for(let i=idx;i<end;i++){
      const e=events[i];
      if(e.pg>=NP)continue;
      if(hmCounts)hmCounts[e.pg]++;
      if(cacheMode&&resMap&&e.op===1&&e.pg<resMap.length&&!resMap[e.pg]){faultCounts[e.dbi]=(faultCounts[e.dbi]||0)+1;faultCurrent[e.dbi]=(faultCurrent[e.dbi]||0)+1}
      if(resMap&&e.pg<resMap.length&&e.op!==3)resMap[e.pg]=1;
      lOp[e.pg]=e.op;lTs[e.pg]=now;
      if(!activeSet.has(e.pg)){activeSet.add(e.pg);activePgs++}
      if(e.op===2&&e.dbi>0&&e.dbi<0xFE)oMap[e.pg]=e.dbi;
      if(showTrails&&i>0&&!((e.op===1&&!sR)||(e.op===2&&!sW)||(e.op===3&&!sF))){const p=events[i-1];if(p.pg!==e.pg)trailPush(p.pg,e.pg,e.op,now)}
    }
    idx=end;
    markZbDirty();kick();
    if(idx<events.length){replayTimer=requestAnimationFrame(step)}
    else{
      replayTimer=null;
      const pin=performance.now()+FADE*10;
      for(const pg of activeSet)lTs[pg]=pin;
      markZbDirty();sched();
      updateBlockPanel();
    }
  }
  replayTimer=requestAnimationFrame(step);
}
function goLive(){
  replayMode=false;replayBlockRef=null;
  if(replayTimer){cancelAnimationFrame(replayTimer);replayTimer=null}
  lOp.fill(0);activeSet.clear();activePgs=0;
  trailStart=0;trailN=0;
  if(liveSnapshot){applyPanelSnap(liveSnapshot);liveSnapshot=null}
  oMapDirty=true;cacheStale=true;
  markZbDirty();sched();
  document.getElementById("block-live").style.color="#4ade80";
  updateBlockPanel();updateCacheStats();
}
window._goLive=goLive;
function connectResidencyWS(){
  const ws=new WebSocket(`${location.protocol==="https:"?"wss:":"ws:"}//${location.host}/ws_residency`);
  ws.binaryType="arraybuffer";
  ws.onclose=()=>setTimeout(connectResidencyWS,3000);
  ws.onerror=()=>ws.close();
  ws.onmessage=msg=>{
    if(!msg.data||msg.data.byteLength<1)return;
    if(replayMode)return;
    const v=new DataView(msg.data);
    const msgType=v.getUint8(0);
    if(msgType===0){
      const src=new Uint8Array(msg.data,1);
      const newLen=src.length;
      if(!resMap||resMap.length!==newLen){
        const oldMap=resMap;const oldLen=oldMap?oldMap.length:0;
        resMap=new Uint8Array(newLen);
        if(oldMap){
          const shared=Math.min(oldLen,newLen,NP);
          for(let i=0;i<shared;i++){
            const ns=src[i],os=oldMap[i];
            if(ns!==os){
              const dbi=oMap?oMap[i]:0;
              if(ns&&!os){cacheTotalCached++;if(cacheCachedPer&&dbi<cacheCachedPer.length)cacheCachedPer[dbi]++}
              else if(!ns&&os){cacheTotalCached--;if(cacheCachedPer&&dbi<cacheCachedPer.length)cacheCachedPer[dbi]--}
            }
            resMap[i]=ns;
          }
          for(let i=shared;i<newLen;i++){
            resMap[i]=src[i];
            if(src[i]){cacheTotalCached++;if(cacheCachedPer&&oMap){const dbi=oMap[i];if(dbi<cacheCachedPer.length)cacheCachedPer[dbi]++}}
          }
        }else{
          resMap.set(src);
          cacheTotalCached=0;if(cacheCachedPer)cacheCachedPer.fill(0);
          const lim=Math.min(newLen,NP,oMap?oMap.length:0);
          for(let i=0;i<lim;i++){
            if(src[i]){cacheTotalCached++;if(cacheCachedPer){const dbi=oMap[i];if(dbi<cacheCachedPer.length)cacheCachedPer[dbi]++}}
          }
        }
      }else{
        const lim=Math.min(newLen,NP,oMap?oMap.length:0);
        for(let i=0;i<lim;i++){
          const ns=src[i],os=resMap[i];
          if(ns!==os){
            const dbi=oMap?oMap[i]:0;
            if(ns&&!os){cacheTotalCached++;if(cacheCachedPer&&dbi<cacheCachedPer.length)cacheCachedPer[dbi]++}
            else if(!ns&&os){cacheTotalCached--;if(cacheCachedPer&&dbi<cacheCachedPer.length)cacheCachedPer[dbi]--}
          }
          resMap[i]=ns;
        }
      }
      cacheStale=true;
      cacheLastUpdate=performance.now();
      faultWindow.push({...faultCurrent});if(faultWindow.length>3)faultWindow.shift();faultCurrent={};
      if(cacheMode)markZbDirty();
      updateCacheStats();
      if(cacheMode)sched();
    }else if(msgType===1){
      if(!resMap)return;
      const spanCount=v.getUint32(1,true);
      let off=5;
      for(let s=0;s<spanCount;s++){
        const start=v.getUint32(off,true);off+=4;
        const len=v.getUint32(off,true);off+=4;
        const state=v.getUint8(off);off+=1;
        for(let p=start;p<start+len&&p<resMap.length;p++){
          const oldState=resMap[p];
          if(oldState!==state){
            const dbi=oMap?oMap[p]:0;
            if(state&&!oldState){cacheTotalCached++;if(cacheCachedPer&&dbi<cacheCachedPer.length)cacheCachedPer[dbi]++}
            else if(!state&&oldState){cacheTotalCached--;if(cacheCachedPer&&dbi<cacheCachedPer.length)cacheCachedPer[dbi]--}
          }
          resMap[p]=state;
        }
      }
      cacheStale=true;
      cacheLastUpdate=performance.now();
      faultWindow.push({...faultCurrent});if(faultWindow.length>3)faultWindow.shift();faultCurrent={};
      if(cacheMode)markZbDirty();
      updateCacheStats();
      if(cacheMode)sched();
    }
  };
}
let cacheStatsPending=false;
function updateCacheStats(){
  if(!cacheStale||!cacheCachedPer)return;
  if(cacheStatsPending)return;
  cacheStatsPending=true;
  requestAnimationFrame(()=>{
    cacheStatsPending=false;
    if(!cacheStale||!cacheCachedPer)return;
    cacheStale=false;
    const limit=Math.min(resMap?resMap.length:0,NP);
    const totalPct=limit>0?(cacheTotalCached/limit*100).toFixed(1):"0";
    const prevTotalPct=limit>0?(cachePrevTotal/limit*100):0;
    const totalDiff=limit>0?(cacheTotalCached/limit*100-prevTotalPct):0;
    const tdS=cachePrevPer?(totalDiff>=0?"+":"")+totalDiff.toFixed(2)+"%":"";
    const tdC=totalDiff>0?"#4ade80":totalDiff<0?"#f87171":"#8b949e";
    document.getElementById("cache-total").innerHTML=`${cacheTotalCached.toLocaleString()}/${limit.toLocaleString()} (${totalPct}%) ${cachePrevPer?`<span style="color:${tdC}">${tdS}</span>`:""}`;
    DBIS.forEach(d=>{
      if(!d._cacheEl)return;
      const total=d.pages;if(total<=0){if(d._cachePct)d._cachePct.textContent="-";if(d._cacheFill)d._cacheFill.style.width="0%";d._diffEl.textContent="";d._faultEl.textContent="";return}
      const cached=cacheCachedPer[d.dbi_index]||0;
      const pct=total>0?(cached/total*100):0;
      if(d._cacheFill)d._cacheFill.style.width=pct.toFixed(1)+"%";
      if(d._cachePct){d._cachePct.textContent=pct.toFixed(1)+"%";d._cachePct.style.color=pct>50?"#4ade80":"#f87171"}
      const prevCached=cachePrevPer?cachePrevPer[d.dbi_index]||0:0;
      const prevPct=total>0?(prevCached/total*100):0;
      const diff=cachePrevPer?(pct-prevPct):0;
      if(cachePrevPer){
        d._diffEl.textContent=(diff>=0?"+":"")+diff.toFixed(2)+"%";
        d._diffEl.style.color=diff>0?"#4ade80":diff<0?"#f87171":"#8b949e";
      }
      const fc=rollingFaults(d.dbi_index);
      d._faultEl.textContent=fc>0?fc+"f":"";
    });
    cachePrevPer=cacheCachedPer.slice();
    cachePrevTotal=cacheTotalCached;
  });
}
async function init(){
  try{
    const r=await fetch("/api/info"),info=await r.json();NP=info.page_count;PS=info.page_size;
    DBIS=info.dbi_names.map((n,i)=>({name:n,dbi_index:i,pages:0,pct:0,size_mb:0}));
    DBI_IDX={};DBIS.forEach(d=>{DBI_IDX[d.dbi_index]=d});
    document.getElementById("subtitle").textContent=`${NP.toLocaleString()} pages \u00b7 loading owner map\u2026`;
  }catch(e){document.getElementById("subtitle").textContent="Failed: "+e.message}
  try{
    const lt=document.getElementById("load-text"),lbw=document.getElementById("load-bar-wrap"),lb=document.getElementById("load-bar");
    lt.textContent="Downloading owner map\u2026";lbw.style.display="block";
    const r=await fetch("/api/owner_map");
    if(r.ok){
      const total=parseInt(r.headers.get("content-length")||"0",10)||NP;
      const reader=r.body.getReader();
      const buf=new Uint8Array(total||NP);let pos=0;
      for(;;){const{done,value}=await reader.read();if(done)break;buf.set(value,pos);pos+=value.length;
        const pct=total>0?Math.min(100,pos/total*100):0;
        lb.style.width=pct.toFixed(1)+"%";
        lt.textContent=`Downloading owner map\u2026 ${(pos/(1024*1024)).toFixed(1)}/${(total/(1024*1024)).toFixed(1)} MB`;
      }
      oMap=buf.length===pos?buf:buf.slice(0,pos);
      lt.textContent="Processing owner map\u2026";lb.style.width="100%";
      await new Promise(r=>setTimeout(r,0));
      const ct={};for(let i=0;i<NP;i++){const o=oMap[i];ct[o]=(ct[o]||0)+1}
      DBIS.forEach(d=>{d.pages=ct[d.dbi_index]||0;d.pct=NP>0?Math.round(d.pages/NP*10000)/100:0;d.size_mb=Math.round(d.pages*PS/(1024*1024)*10)/10});
    }else{oMap=new Uint8Array(NP);oMap.fill(0xFF)}
  }catch(e){oMap=new Uint8Array(NP);oMap.fill(0xFF)}
  unrefCount=oMap.reduce((n,b)=>n+(b===0xFF?1:0),0);const ref=NP-unrefCount;
  const gb=(NP*PS/(1024**3)).toFixed(2);
  document.getElementById("subtitle").textContent=`${NP.toLocaleString()} pages \u00b7 ${ref.toLocaleString()} ref \u00b7 ${unrefCount.toLocaleString()} unref \u00b7 ${PS>=1024?(PS/1024)+"K":PS} \u00b7 ${gb} GB \u00b7 ${DBIS.length} tables`;
  lOp=new Uint8Array(NP);lTs=new Float64Array(NP);hmCounts=new Uint32Array(NP);
  cacheCachedPer=new Array(DBIS.length).fill(0);
  DBIS.forEach(d=>{sparkData[d.dbi_index]={ring:new Array(SPARK_SECS).fill(0),head:0};sparkAccum[d.dbi_index]=0;flameData[d.dbi_index]=new Array(FLAME_SECS).fill(0)});
  bldTbl();buildUnifiedPanel();
  let treeInfo=[];
  try{const r=await fetch("/api/tree_info");if(r.ok)treeInfo=await r.json()}catch(e){}
  if(treeInfo.length>0)buildTreeInfo(treeInfo);
  ldEl.style.display="none";cv.style.display="block";boot();connectWS();connectResidencyWS();
  const flCv=document.getElementById("flame");
  flCv.addEventListener("mousemove",e=>{
    if(!showFlame)return;
    const at=DBIS.filter(d=>d.pages>0);if(!at.length){tt.style.display="none";return}
    const rect=flCv.getBoundingClientRect();
    const mx=e.clientX-rect.left,my=e.clientY-rect.top;
    const lw=42,rw=flCv.width-lw;
    const rowH=Math.max(4,Math.floor((flCv.height-14)/Math.max(1,at.length)));
    const ri=Math.floor(my/rowH);
    if(ri<0||ri>=at.length||mx<lw){tt.style.display="none";return}
    const d=at[ri],c=PAL[d.dbi_index]||PAL[255];
    const secIdx=Math.floor((mx-lw)/rw*FLAME_SECS);
    const idx=((flameHead-FLAME_SECS+secIdx)%FLAME_SECS+FLAME_SECS)%FLAME_SECS;
    const fd=flameData[d.dbi_index];
    const ops=fd?fd[idx]:0;
    const ago=FLAME_SECS-secIdx;
    ttSw.style.background=`rgb(${c[0]},${c[1]},${c[2]})`;
    ttNm.textContent=d.name;
    ttDt.innerHTML=`${ops.toLocaleString()} ops/s \u00b7 ${ago}s ago`;
    tt.style.display="block";tt.style.left=(e.clientX+14)+"px";tt.style.top=(e.clientY+14)+"px";
  });
  flCv.addEventListener("mouseleave",()=>{tt.style.display="none"});
  setInterval(()=>{
    DBIS.forEach(d=>{
      const v=sparkAccum[d.dbi_index]||0;
      const sd=sparkData[d.dbi_index];if(sd){sd.ring[sd.head%SPARK_SECS]=v;sd.head++}
      const fd=flameData[d.dbi_index];if(fd)fd[flameHead%FLAME_SECS]=v;
      sparkAccum[d.dbi_index]=0;
    });
    flameHead++;
    DBIS.forEach(d=>drawSparkline(d));
    if(showFlame)drawFlame();
  },1000);
  setInterval(()=>{if(!oMap||!oMapDirty||replayMode)return;oMapDirty=false;
    DBIS.forEach(d=>{d.pct=NP>0?Math.round(d.pages/NP*10000)/100:0;d.size_mb=Math.round(d.pages*PS/(1024*1024)*10)/10});
    bldTbl();uAR();markZbDirty();sched();
    const rf=NP-unrefCount,gb=(NP*PS/(1024**3)).toFixed(2);
    document.getElementById("subtitle").textContent=`${NP.toLocaleString()} pages \u00b7 ${rf.toLocaleString()} ref \u00b7 ${unrefCount.toLocaleString()} unref \u00b7 ${PS>=1024?(PS/1024)+"K":PS} \u00b7 ${gb} GB \u00b7 ${DBIS.length} tables`;
  },2000);
  setInterval(()=>{
    if(!cacheLastUpdate)return;
    const ago=Math.round((performance.now()-cacheLastUpdate)/1000);
    let txt;
    if(ago<60)txt=ago+"s ago";
    else if(ago<3600)txt=Math.floor(ago/60)+"m "+ago%60+"s ago";
    else txt=Math.floor(ago/3600)+"h ago";
    document.getElementById("cache-ago").textContent=txt;
  },1000);
  setInterval(()=>{if(blockPanelDirty)updateBlockPanel()},250);
  setInterval(()=>{
    if(activeSet.size<5000)return;
    const now=performance.now();
    for(const pg of activeSet){
      if(!lOp[pg]||now-lTs[pg]>=FADE){activeSet.delete(pg);if(lOp[pg]){lOp[pg]=0;activePgs=Math.max(0,activePgs-1)}}
    }
  },5000);
}
init();
})();
</script>
</body>
</html>
