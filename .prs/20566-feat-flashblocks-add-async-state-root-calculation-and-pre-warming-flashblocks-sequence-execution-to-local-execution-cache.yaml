number: 20566
title: 'feat(flashblocks): Add async state root calculation and pre-warming flashblocks sequence execution to local execution cache'
state: open
author: sieniven
head: niven/flashblocks-exec-cache
base: main
labels: []
created_at: 2025-12-22T12:33:40Z
updated_at: 2026-01-19T11:44:44Z
additions: 548
deletions: 262
is_draft: false
files:
- path: Cargo.lock
  additions: 1
  deletions: 0
- path: crates/engine/primitives/src/message.rs
  additions: 23
  deletions: 1
- path: crates/engine/tree/src/engine.rs
  additions: 9
  deletions: 3
- path: crates/engine/tree/src/tree/mod.rs
  additions: 1
  deletions: 0
- path: crates/engine/util/src/engine_store.rs
  additions: 1
  deletions: 0
- path: crates/evm/evm/src/execute.rs
  additions: 49
  deletions: 2
- path: crates/optimism/flashblocks/Cargo.toml
  additions: 1
  deletions: 1
- path: crates/optimism/flashblocks/src/cache.rs
  additions: 312
  deletions: 202
- path: crates/optimism/flashblocks/src/payload.rs
  additions: 14
  deletions: 10
- path: crates/optimism/flashblocks/src/service.rs
  additions: 47
  deletions: 16
- path: crates/optimism/flashblocks/src/worker.rs
  additions: 54
  deletions: 17
- path: crates/optimism/flashblocks/src/ws/decoding.rs
  additions: 1
  deletions: 1
- path: crates/optimism/flashblocks/src/ws/stream.rs
  additions: 4
  deletions: 4
- path: crates/optimism/payload/src/builder.rs
  additions: 1
  deletions: 1
- path: crates/optimism/rpc/src/eth/mod.rs
  additions: 4
  deletions: 2
- path: crates/rpc/rpc-eth-api/src/helpers/pending_block.rs
  additions: 1
  deletions: 1
- path: examples/custom-node/src/primitives/header.rs
  additions: 25
  deletions: 1
body: "## Summary\r\n\r\nThis PR references the flashblocks RPC solution 1 mentioned in: https://github.com/paradigmxyz/reth/issues/20491. It optimizes the sync for flashblocks RPC (CL sync and flashblocks sync) by inserting the executed flashblocks sequence to the engine state tree, to prevent re-execution and re-calculating of state root of the same payload on engine_newPayload engine api. This should optimize the RPC sync speed and improve latencies on the RPC node.\r\n\r\n1. Flashblocks RPC sync logic is now split into 2 portions. New incoming flashblocks sequence are validated and executed without state root calculation quickly, which updates the pending state on the eth api handler as quickly as possible\r\n2. State root calculation and subsequent sync logic (flashblock or CL driven syncs) are shifted to async\r\n3. If flashblocks RPC node chainstate is driven by the CL sync (`--flashblocks.consensus` turned off), which this PR optimizes the sync speed of the CL sync as unsafe payload commits on the CL will skip payload re-validation on cache hits, which the flashblocks RPC has already executed and validated the sequence as the current pending block\r\n2. With `--flashblocks.consensus` enabled, this optimizes the RPC node sync with the flashblocks builder source, as we cache hit locally executed blocks prevent re-execution of the same payload on the flashblocks RPC node"
