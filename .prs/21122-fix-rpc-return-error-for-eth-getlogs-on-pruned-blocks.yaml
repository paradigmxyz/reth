number: 21122
title: 'fix(rpc): return error for eth_getLogs on pruned blocks'
state: open
author: kustrun
head: fix/eth-getlogs-pruned-error
base: main
labels: []
created_at: 2026-01-16T14:48:23Z
updated_at: 2026-01-20T14:45:09Z
additions: 165
deletions: 19
is_draft: false
files:
- path: Cargo.lock
  additions: 1
  deletions: 0
- path: crates/rpc/rpc-eth-api/src/node.rs
  additions: 8
  deletions: 2
- path: crates/rpc/rpc/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/rpc/rpc/src/eth/core.rs
  additions: 4
  deletions: 1
- path: crates/rpc/rpc/src/eth/filter.rs
  additions: 132
  deletions: 11
- path: crates/storage/provider/src/test_utils/mock.rs
  additions: 13
  deletions: 3
- path: crates/storage/provider/src/traits/full.rs
  additions: 2
  deletions: 0
- path: crates/storage/storage-api/src/full.rs
  additions: 4
  deletions: 2
body: "\r\n## Summary\r\n\r\nThis PR fixes an inconsistency in RPC error handling when querying pruned blocks.\r\n\r\n## Problem\r\n\r\nCurrently, `eth_getLogs` returns an empty array `[]` when querying blocks that have been pruned, while other RPC methods like `eth_getBalance` correctly return an error:\r\n\r\n```json\r\n// eth_getBalance on pruned block (current behavior - correct)\r\n{\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32603,\"message\":\"state at block #12369623 is pruned\"}}\r\n\r\n// eth_getLogs on pruned block (current behavior - incorrect)\r\n{\"jsonrpc\":\"2.0\",\"id\":1,\"result\":[]}\r\n```\r\n\r\nThis inconsistency can mislead users and applications into thinking no logs exist for those blocks, when in reality the data is simply unavailable due to pruning.\r\n\r\n## Solution\r\n\r\nAdded a pruning check in `logs_for_filter()` that verifies the requested block range doesn't overlap with pruned receipts data. When it does, the same error as `eth_getBalance` is returned:\r\n\r\n```json\r\n// eth_getLogs on pruned block (after fix)\r\n{\"jsonrpc\":\"2.0\",\"id\":1,\"error\":{\"code\":-32603,\"message\":\"state at block #12369623 is pruned\"}}\r\n```\r\n\r\nThe check only verifies the `Receipts` prune segment (not `ContractLogs`), since `ContractLogs` pruning still keeps some receipts and can return partial results.\r\n\r\n## Changes\r\n\r\n- Added `PruneCheckpointReader` trait bound to filter-related impl blocks\r\n- Added `check_receipts_pruning()` helper method in `EthFilterInner`\r\n- Added pruning check for both block range queries and `AtBlockHash` queries\r\n- Extended `MockEthProvider` to support configurable prune checkpoints for testing\r\n- Added unit tests for the pruning check\r\n\r\n## Test Plan\r\n\r\n- `cargo test -p reth-rpc` - all 39 tests pass\r\n- `cargo clippy -p reth-rpc --all-features` - no warnings\r\n"
