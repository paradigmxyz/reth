number: 21115
title: 'refactor(db): use hashed state as canonical state representation'
state: open
author: gakonst
head: remove-plain-state
base: main
labels: []
created_at: 2026-01-16T10:39:00Z
updated_at: 2026-01-20T22:04:13Z
additions: 337
deletions: 24
is_draft: false
files:
- path: crates/cli/commands/src/db/settings.rs
  additions: 29
  deletions: 0
- path: crates/cli/commands/src/node.rs
  additions: 7
  deletions: 1
- path: crates/node/core/src/args/database.rs
  additions: 13
  deletions: 0
- path: crates/node/core/src/args/mod.rs
  additions: 4
  deletions: 0
- path: crates/node/core/src/args/storage.rs
  additions: 142
  deletions: 0
- path: crates/node/core/src/node_config.rs
  additions: 16
  deletions: 1
- path: crates/stages/stages/src/stages/hashing_account.rs
  additions: 24
  deletions: 2
- path: crates/stages/stages/src/stages/hashing_storage.rs
  additions: 18
  deletions: 1
- path: crates/storage/db-api/src/models/metadata.rs
  additions: 22
  deletions: 0
- path: crates/storage/provider/src/providers/state/historical.rs
  additions: 27
  deletions: 8
- path: crates/storage/provider/src/providers/state/latest.rs
  additions: 35
  deletions: 11
body: "## Summary\n\nThis PR removes the need for `PlainAccountState` and `PlainStorageState` tables by writing directly to `HashedAccounts` and `HashedStorages` during execution. **This is now configurable via CLI flags.**\n\n## Motivation\n\nThe current architecture maintains duplicate state:\n- **Plain state tables** (`PlainAccountState`, `PlainStorageState`) - indexed by unhashed addresses/slots\n- **Hashed state tables** (`HashedAccounts`, `HashedStorages`) - indexed by keccak256 hashes\n\nThe `AccountHashingStage` and `StorageHashingStage` convert from plain to hashed state, which is required for Merkle trie operations. This creates:\n- ~2x storage overhead for state data\n- Additional I/O during sync\n- Pipeline complexity\n\n## Configuration\n\n### CLI Flags\n\nThe hashed state mode is now **configurable via CLI**:\n\n```bash\n# Start node with hashed state enabled (for new databases only)\nreth node --storage.use-hashed-state\n\n# View current storage settings\nreth db settings get\n\n# Change storage settings on existing database (requires resync)\nreth db settings set use_hashed_state true\n```\n\n### StorageSettings\n\nA new `use_hashed_state` field has been added to `StorageSettings`:\n\n```rust\npub struct StorageSettings {\n    // ... existing fields ...\n    /// Whether to use hashed state tables as canonical state representation\n    pub use_hashed_state: bool,\n}\n```\n\n### StorageArgs\n\nNew CLI argument struct with all storage configuration options:\n\n| Flag | Description |\n|------|-------------|\n| `--storage.use-hashed-state` | Use hashed tables as canonical state |\n| `--storage.receipts-in-static-files` | Store receipts in static files |\n| `--storage.transaction-senders-in-static-files` | Store senders in static files |\n| `--storage.account-changesets-in-static-files` | Store changesets in static files |\n| `--storage.storages-history-in-rocksdb` | Store storage history in RocksDB |\n| `--storage.transaction-hash-numbers-in-rocksdb` | Store tx hashes in RocksDB |\n| `--storage.account-history-in-rocksdb` | Store account history in RocksDB |\n\n## Changes\n\n### Provider Layer\n- `LatestStateProviderRef`: Reads from `HashedAccounts`/`HashedStorages` with keccak256 hashing at lookup boundary (when `use_hashed_state` is enabled)\n- `HistoricalStateProviderRef`: Uses hashed tables for \"in plain state\" lookups\n- `DatabaseProvider`: \n  - `write_state_changes` writes directly to hashed tables\n  - `write_state_reverts` uses hashed tables\n  - `populate_bundle_state` uses hashed cursors\n\n### Stages\n- `AccountHashingStage`: Now a no-op when `use_hashed_state` is enabled\n- `StorageHashingStage`: Now a no-op when `use_hashed_state` is enabled\n\nThe stages are kept for pipeline compatibility but perform no work since execution handles hashing.\n\n### New Files\n- `crates/node/core/src/args/storage.rs` - StorageArgs CLI struct\n- `crates/storage/db-api/src/models/metadata.rs` - Updated StorageSettings\n\n### Updated Files\n- `crates/node/core/src/node_config.rs` - Added `storage: StorageArgs` field\n- `crates/cli/commands/src/node.rs` - Wired StorageArgs into NodeCommand\n- `crates/cli/commands/src/db/settings.rs` - Added `use_hashed_state` setting management\n\n## Benefits\n\n| Before | After |\n|--------|-------|\n| Write to plain state â†’ Hash to hashed state | Write directly to hashed state |\n| 2 tables per state type | 1 table per state type |\n| Hashing stages required | Hashing stages are no-ops |\n| Not configurable | Configurable via CLI |\n\n## Testing\n\n- [x] `cargo check -p reth-provider --lib` passes\n- [x] `cargo check -p reth-stages --lib` passes\n- [x] `cargo check -p reth` passes\n- [x] `cargo test -p reth-node-core --lib -- storage` passes (4 tests)\n- [ ] Full test suite (requires CI)\n\n## Migration Notes\n\n- Existing databases continue to work with default settings (plain state mode)\n- Enable hashed state for **new databases only** with `--storage.use-hashed-state`\n- Changing `use_hashed_state` on an existing database requires a full resync\n- Plain state tables are no longer read/written when hashed state is enabled\n\n## Follow-up Work\n\n- Remove `PlainAccountState` and `PlainStorageState` from table schema (after deprecation period)\n- Update CLI commands that reference plain state tables\n- Update benchmarks and examples\n- Add database migration for existing nodes"
