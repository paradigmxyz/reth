number: 21185
title: 'perf(storage): add bloom filter for empty storage slots'
state: open
author: gakonst
head: tempo/storage-bloom-filter
base: main
labels:
- C-perf
created_at: 2026-01-19T10:18:11Z
updated_at: 2026-01-19T12:08:40Z
additions: 746
deletions: 4
is_draft: true
files:
- path: Cargo.lock
  additions: 44
  deletions: 0
- path: Cargo.toml
  additions: 2
  deletions: 0
- path: crates/engine/tree/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/engine/tree/src/tree/payload_validator.rs
  additions: 21
  deletions: 4
- path: crates/storage/provider/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/storage/provider/src/providers/mod.rs
  additions: 1
  deletions: 0
- path: crates/storage/provider/src/providers/state/bloom.rs
  additions: 343
  deletions: 0
- path: crates/storage/provider/src/providers/state/mod.rs
  additions: 2
  deletions: 0
- path: crates/storage/storage-bloom/Cargo.toml
  additions: 32
  deletions: 0
- path: crates/storage/storage-bloom/src/bloom.rs
  additions: 203
  deletions: 0
- path: crates/storage/storage-bloom/src/lib.rs
  additions: 30
  deletions: 0
- path: crates/storage/storage-bloom/src/metrics.rs
  additions: 19
  deletions: 0
- path: crates/storage/storage-bloom/src/provider.rs
  additions: 47
  deletions: 0
body: "## Summary\n\nImplements a bloom filter to short-circuit storage reads for empty slots, potentially avoiding RocksDB lookups for 30-40% of storage reads.\n\nBased on analysis from Nethermind's FlatDB work ([PR #9854](https://github.com/NethermindEth/nethermind/pull/9854)):\n- Mainnet has ~500M-1B non-empty storage slots  \n- A bloom filter can definitively say 'not present' for empty slots\n- Potential 10-20% mgas/s improvement on some block ranges\n\n## Architecture\n\n- New `reth-storage-bloom` crate with `GrowableBloom` filter\n- `BloomStateProvider` wrapper that checks bloom before DB access\n- Metrics for bloom hits, misses, and false positives\n- Persistence support for saving/loading bloom to disk\n\n## Trade-offs\n\nFrom Nethermind's experience:\n- **Memory**: ~1-2GB for mainnet scale at 1% false positive rate\n- **Write amplification**: Every storage write updates bloom\n- **Uncertain ROI**: Depends heavily on workload characteristics\n\n## How to Test\n\nThis is feature-gated behind `storage-bloom` flag. To enable:\n\n```toml\nreth-provider = { features = [\"storage-bloom\"] }\n```\n\n## Benchmark Request\n\nNeed to benchmark on mainnet block re-execution to measure:\n1. Storage read reduction (bloom hit rate)\n2. False positive rate\n3. Overall mgas/s impact\n4. Memory overhead\n\ncc @brian @alexey - please review benchmark results when available\n\n## Closes\n\nCloses #21184"
