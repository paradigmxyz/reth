number: 21145
title: 'feat: clone MDBX read-only transactions for parallel state root'
state: open
author: mediocregopher
head: mediocregopher/mdbx-tx-clone
base: main
labels: []
created_at: 2026-01-16T22:07:00Z
updated_at: 2026-01-20T13:05:42Z
additions: 17992
deletions: 6421
is_draft: true
files:
- path: Cargo.lock
  additions: 3
  deletions: 0
- path: crates/cli/commands/src/db/repair_trie.rs
  additions: 12
  deletions: 8
- path: crates/engine/tree/Cargo.toml
  additions: 2
  deletions: 0
- path: crates/engine/tree/benches/state_root_task.rs
  additions: 8
  deletions: 6
- path: crates/engine/tree/src/tree/payload_processor/mod.rs
  additions: 29
  deletions: 31
- path: crates/engine/tree/src/tree/payload_processor/multiproof.rs
  additions: 10
  deletions: 6
- path: crates/engine/tree/src/tree/payload_validator.rs
  additions: 41
  deletions: 29
- path: crates/ethereum/payload/src/lib.rs
  additions: 1
  deletions: 1
- path: crates/exex/exex/src/backfill/stream.rs
  additions: 2
  deletions: 2
- path: crates/exex/exex/src/notifications.rs
  additions: 4
  deletions: 4
- path: crates/net/network/src/test_utils/testnet.rs
  additions: 1
  deletions: 0
- path: crates/optimism/node/src/engine.rs
  additions: 2
  deletions: 2
- path: crates/optimism/payload/src/builder.rs
  additions: 1
  deletions: 1
- path: crates/optimism/rpc/src/engine.rs
  additions: 1
  deletions: 1
- path: crates/optimism/rpc/src/eth/ext.rs
  additions: 1
  deletions: 1
- path: crates/optimism/rpc/src/witness.rs
  additions: 1
  deletions: 0
- path: crates/ress/provider/src/lib.rs
  additions: 1
  deletions: 1
- path: crates/rpc/rpc-engine-api/src/engine_api.rs
  additions: 3
  deletions: 3
- path: crates/rpc/rpc-eth-api/src/helpers/config.rs
  additions: 1
  deletions: 0
- path: crates/rpc/rpc/src/reth.rs
  additions: 2
  deletions: 1
- path: crates/rpc/rpc/src/validation.rs
  additions: 1
  deletions: 0
- path: crates/storage/db-api/src/database.rs
  additions: 2
  deletions: 2
- path: crates/storage/db-api/src/mock.rs
  additions: 4
  deletions: 0
- path: crates/storage/db-api/src/transaction.rs
  additions: 8
  deletions: 0
- path: crates/storage/db/src/implementation/mdbx/tx.rs
  additions: 34
  deletions: 1
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/CMakeLists.txt
  additions: 108
  deletions: 365
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/COPYRIGHT
  additions: 159
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ChangeLog.md
  additions: 2148
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/GNUmakefile
  additions: 75
  deletions: 27
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/NOTICE
  additions: 13
  deletions: 9
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/README.md
  additions: 528
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/VERSION.json
  additions: 1
  deletions: 1
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ci.sh
  additions: 82
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/cmake/compiler.cmake
  additions: 1
  deletions: 4
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/cmake/profile.cmake
  additions: 1
  deletions: 1
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/cmake/utils.cmake
  additions: 15
  deletions: 197
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/config.h.in
  additions: 11
  deletions: 3
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_chk.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_copy.1
  additions: 7
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_drop.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_dump.1
  additions: 7
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_load.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_stat.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.c
  additions: 6844
  deletions: 3856
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.c++
  additions: 4136
  deletions: 207
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.h
  additions: 468
  deletions: 54
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.h++
  additions: 1145
  deletions: 1036
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_chk.c
  additions: 154
  deletions: 67
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_copy.c
  additions: 133
  deletions: 46
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_drop.c
  additions: 130
  deletions: 46
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_dump.c
  additions: 162
  deletions: 83
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_load.c
  additions: 141
  deletions: 48
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_stat.c
  additions: 162
  deletions: 71
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/packages/archlinux/.SRCINFO
  additions: 16
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/packages/archlinux/PKGBUILD
  additions: 38
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/packages/buildroot/0001-package-libmdbx.patch
  additions: 75
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/CMakeLists.txt
  additions: 43
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/README.md
  additions: 11
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/example-mdbx.c
  additions: 167
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/example-mdbx.c++
  additions: 87
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/pcrf/pcrf_simulator.c
  additions: 367
  deletions: 0
- path: crates/storage/libmdbx-rs/src/transaction.rs
  additions: 39
  deletions: 4
- path: crates/storage/libmdbx-rs/tests/cursor.rs
  additions: 5
  deletions: 5
- path: crates/storage/libmdbx-rs/tests/transaction.rs
  additions: 8
  deletions: 8
- path: crates/storage/provider/src/providers/database/metrics.rs
  additions: 1
  deletions: 1
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 54
  deletions: 0
- path: crates/storage/provider/src/providers/state/overlay.rs
  additions: 39
  deletions: 1
- path: crates/storage/provider/src/test_utils/mock.rs
  additions: 10
  deletions: 0
- path: crates/storage/provider/src/traits/full.rs
  additions: 11
  deletions: 3
- path: crates/storage/storage-api/src/block_id.rs
  additions: 1
  deletions: 1
- path: crates/storage/storage-api/src/database_provider.rs
  additions: 12
  deletions: 0
- path: crates/transaction-pool/src/lib.rs
  additions: 5
  deletions: 2
- path: crates/transaction-pool/src/validate/eth.rs
  additions: 1
  deletions: 1
- path: crates/trie/parallel/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/trie/parallel/benches/root.rs
  additions: 14
  deletions: 9
- path: crates/trie/parallel/src/proof.rs
  additions: 6
  deletions: 3
- path: crates/trie/parallel/src/proof_task.rs
  additions: 124
  deletions: 114
- path: crates/trie/parallel/src/root.rs
  additions: 27
  deletions: 18
- path: examples/custom-engine-types/src/main.rs
  additions: 1
  deletions: 1
- path: examples/db-access/src/main.rs
  additions: 14
  deletions: 16
- path: examples/rpc-db/src/myrpc_ext.rs
  additions: 1
  deletions: 1
body: "## Summary                                                                                                                                                                                      \r\n                                                                                                                                                                                                \r\nThis PR enables cloning of MDBX read-only transactions, allowing `OverlayStateProvider` to be passed directly to proof workers and parallel state root computation instead of using a factory pa\r\nttern.                                                                                                                                                                                          \r\n                                                                                                                                                                                                \r\n### Key Changes:                                                                                                                                                                                \r\n                                                                                                                                                                                                \r\n1. **Updated vendored libmdbx** to v0.14.1 which includes `mdbx_txn_clone` support                                                                                                              \r\n2. **Added `clone_tx()`** to `Transaction<RO>` in reth-libmdbx for deep cloning read-only transactions                                                                                          \r\n3. **Made `DbTx` require `Clone`** and implemented `Clone` for `Tx<K>`                                                                                                                          \r\n4. **Made `OverlayStateProvider` clonable** by deriving `Clone`                                                                                                                                \r\n5. **Refactored `ProofWorker`** to accept a clonable provider directly instead of a factory                                                                                                     \r\n6. **Updated `ParallelStateRoot`** to accept a clonable provider instead of `DatabaseProviderROFactory`                                                                                        \r\n7. **Updated parallel/serial state root codepaths** in payload validator to use `OverlayStateProvider` directly                                                                                 \r\n                                                                                                                                                                                                \r\n### Benefits:                                                                                                                                                                                   \r\n                                                                                                                                                                                                \r\n- Eliminates redundant provider creation overhead in parallel state root computation                                                                                                            \r\n- Simplifies the API by removing factory indirection where possible                                                                                                                             \r\n- Enables more efficient sharing of database state across parallel tasks "
