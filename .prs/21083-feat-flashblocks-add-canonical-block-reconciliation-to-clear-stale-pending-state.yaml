number: 21083
title: 'feat(flashblocks): add canonical block reconciliation to clear stale pending state'
state: open
author: teddyknox
head: teddyknox/fb-c-block-reconciliation
base: main
labels: []
created_at: 2026-01-14T23:27:38Z
updated_at: 2026-01-14T23:27:39Z
additions: 884
deletions: 8
is_draft: false
files:
- path: crates/optimism/flashblocks/src/cache.rs
  additions: 250
  deletions: 2
- path: crates/optimism/flashblocks/src/lib.rs
  additions: 3
  deletions: 1
- path: crates/optimism/flashblocks/src/service.rs
  additions: 83
  deletions: 5
- path: crates/optimism/flashblocks/src/validation.rs
  additions: 548
  deletions: 0
body: "Stacked on top of https://github.com/paradigmxyz/reth/pull/21081, will rebase once that merges.\r\n\r\n## Summary\r\n\r\n  Wire up the validation module to handle canonical block notifications, enabling the service to detect reorgs and clear stale pending state.\r\n\r\n  Part of the [speculative flashblock building design](https://www.notion.so/oplabs/Flashblocks-Upstreaming-node-reth-features-2e8f153ee162805eaaa5f067fe3440a3?source=copy_link). Builds on [PR 1](https://github.com/paradigmxyz/reth/pull/21081).\r\n\r\n  ## Motivation\r\n\r\n  When the canonical chain advances or diverges from pending flashblock state, the service needs to reconcile. Without this, stale pending state persists until eventually overwritten, and there's no explicit signal to downstream consumers that a reorg occurred.\r\n\r\n  ## Changes\r\n\r\n  **`cache.rs`**\r\n  - Add `earliest_block_number()` and `latest_block_number()` to `SequenceManager`\r\n  - Add `get_transaction_hashes_for_block()` for reorg detection\r\n  - Add `process_canonical_block()` that uses `ReorgDetector` and `CanonicalBlockReconciler` to determine and apply reconciliation strategy\r\n  - Add `clear_all()` helper\r\n\r\n  **`service.rs`**\r\n  - Add `CanonicalBlockNotification` type with block number and transaction hashes\r\n  - Add `canonical_block_rx` receiver field and `with_canonical_block_rx()` builder method\r\n  - Add `max_depth` configuration with `with_max_depth()` builder method (default: 64)\r\n  - Handle canonical block notifications in the main loop, calling `process_canonical_block()`\r\n  - Add `reorg_count` metric\r\n\r\n  ## Testing\r\n\r\n  Unit tests for:\r\n  - `process_canonical_block()` with each reconciliation strategy\r\n  - `earliest_block_number()` / `latest_block_number()` tracking across pending and cached sequences"
