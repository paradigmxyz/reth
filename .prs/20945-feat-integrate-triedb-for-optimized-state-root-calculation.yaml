number: 20945
title: 'feat: integrate TrieDB for optimized state root calculation'
state: open
author: cliff0412
head: feature/cliff/triedb
base: main
labels: []
created_at: 2026-01-12T03:20:46Z
updated_at: 2026-01-21T09:21:23Z
additions: 3314
deletions: 67
is_draft: false
files:
- path: .gitignore
  additions: 1
  deletions: 0
- path: Cargo.lock
  additions: 54
  deletions: 0
- path: Cargo.toml
  additions: 3
  deletions: 0
- path: DockerfileOp
  additions: 1
  deletions: 1
- path: crates/chain-state/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/chain-state/src/memory_overlay.rs
  additions: 62
  deletions: 4
- path: crates/cli/commands/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/cli/commands/src/common.rs
  additions: 13
  deletions: 3
- path: crates/cli/commands/src/stage/dump/execution.rs
  additions: 2
  deletions: 1
- path: crates/cli/commands/src/stage/dump/hashing_account.rs
  additions: 2
  deletions: 1
- path: crates/cli/commands/src/stage/dump/hashing_storage.rs
  additions: 2
  deletions: 1
- path: crates/cli/commands/src/stage/dump/merkle.rs
  additions: 2
  deletions: 1
- path: crates/e2e-test-utils/src/setup_import.rs
  additions: 2
  deletions: 0
- path: crates/evm/evm/Cargo.toml
  additions: 1
  deletions: 1
- path: crates/evm/evm/src/execute.rs
  additions: 84
  deletions: 5
- path: crates/evm/evm/src/metrics.rs
  additions: 3
  deletions: 0
- path: crates/node/builder/src/launch/common.rs
  additions: 8
  deletions: 1
- path: crates/node/builder/src/launch/engine.rs
  additions: 3
  deletions: 0
- path: crates/node/core/src/args/datadir_args.rs
  additions: 3
  deletions: 0
- path: crates/node/core/src/dirs.rs
  additions: 12
  deletions: 0
- path: crates/optimism/bin/Cargo.toml
  additions: 3
  deletions: 0
- path: crates/optimism/bin/src/main.rs
  additions: 7
  deletions: 0
- path: crates/optimism/cli/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/optimism/evm/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/optimism/node/Cargo.toml
  additions: 8
  deletions: 0
- path: crates/optimism/node/tests/it/engine.rs
  additions: 644
  deletions: 0
- path: crates/optimism/node/tests/it/main.rs
  additions: 2
  deletions: 0
- path: crates/optimism/storage/Cargo.toml
  additions: 1
  deletions: 0
- path: crates/stages/stages/src/test_utils/test_db.rs
  additions: 9
  deletions: 1
- path: crates/storage/db-common/Cargo.toml
  additions: 6
  deletions: 0
- path: crates/storage/db-common/src/init.rs
  additions: 235
  deletions: 8
- path: crates/storage/db/src/lib.rs
  additions: 8
  deletions: 0
- path: crates/storage/provider/Cargo.toml
  additions: 12
  deletions: 0
- path: crates/storage/provider/benches/bench_state_root_overlay.rs
  additions: 243
  deletions: 0
- path: crates/storage/provider/src/providers/blockchain_provider.rs
  additions: 7
  deletions: 1
- path: crates/storage/provider/src/providers/database/builder.rs
  additions: 62
  deletions: 7
- path: crates/storage/provider/src/providers/database/mod.rs
  additions: 36
  deletions: 2
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 183
  deletions: 4
- path: crates/storage/provider/src/providers/mod.rs
  additions: 7
  deletions: 0
- path: crates/storage/provider/src/providers/state/historical.rs
  additions: 91
  deletions: 11
- path: crates/storage/provider/src/providers/state/latest.rs
  additions: 65
  deletions: 10
- path: crates/storage/provider/src/providers/triedb/mod.rs
  additions: 778
  deletions: 0
- path: crates/storage/provider/src/providers/triedb_stub.rs
  additions: 141
  deletions: 0
- path: crates/storage/provider/src/test_utils/mod.rs
  additions: 9
  deletions: 2
- path: crates/storage/provider/src/traits/mod.rs
  additions: 3
  deletions: 0
- path: crates/storage/provider/src/traits/triedb_provider.rs
  additions: 9
  deletions: 0
- path: crates/storage/storage-api/Cargo.toml
  additions: 3
  deletions: 0
- path: crates/storage/storage-api/src/macros.rs
  additions: 1
  deletions: 0
- path: crates/storage/storage-api/src/trie.rs
  additions: 34
  deletions: 2
- path: docs/performance/images/perf-with-tdb-threshold-2.png
  additions: 0
  deletions: 0
- path: docs/performance/images/perf-with-tdb-threshold-32.png
  additions: 0
  deletions: 0
- path: docs/performance/images/perf-without-tdb-threshold-2.png
  additions: 0
  deletions: 0
- path: docs/performance/images/perf-without-tdb-threshold-32.png
  additions: 0
  deletions: 0
- path: docs/performance/images/violin_overlay_1000.svg
  additions: 61
  deletions: 0
- path: docs/performance/images/violin_overlay_10000.svg
  additions: 61
  deletions: 0
- path: docs/performance/perf_triedb.md
  additions: 323
  deletions: 0
body: "## Summary\r\n\r\n  This PR integrates [Base's TrieDB](https://github.com/base/triedb) into reth for optimized state root calculation during block production. TrieDB is a memory-mapped trie database with page design optimized for MPT (Merkle Patricia Trie) structure, unlike MDBX which uses a binary tree page structure (which is for general kv store).\r\n\r\n  ### Key Changes\r\n\r\n  - Add `triedb` feature flag to enable TrieDB support\r\n  - Integrate TrieDB into `ProviderFactory` architecture via `TrieDBProvider`\r\n  - Implement state persistence to TrieDB after block production\r\n  - Add support for `init_genesis` with TrieDB\r\n  - Add microbenchmarks and metrics for state root calculation\r\n\r\n  ### Performance Improvements\r\n\r\n  | Dataset | TPS Improvement | State Root Speedup |\r\n  |---------|-----------------|-------------------|\r\n  | Small (1GB genesis) | **+20.58%** | **3.18x** |\r\n  | Medium (3GB genesis) | **+23.86%** | **6.27x** |\r\n\r\n  **Microbenchmarks** show up to **131x speedup** for isolated state root calculations (1,000 account overlay: 416ms â†’ 3.17ms).\r\n\r\n  ### Why TrieDB is Faster\r\n\r\n  CPU profiling reveals that without TrieDB, the `TrieUpdates::extend_from_sorted` functions become a bottleneck when `PERSISTENCE_THRESHOLD` increases (6x overhead increase from threshold=2 to threshold=32).\r\n\r\n  TrieDB **eliminates this bottleneck entirely** by:\r\n  - Merging plain state (addresses, storage keys) instead of pre-computed trie nodes, eliminating `extend_from_sorted`\r\n  - Reducing overall CPU usage by 20-22% compared to MDBX\r\n\r\n  For detailed benchmarks and profiling analysis, see [docs/performance/perf_triedb.md](https://github.com/okx/reth/blob/feature/cliff/triedb/docs/performance/perf_triedb.md).\r\n\r\n  ## Test Plan\r\n\r\n  - [x] Run microbenchmarks: `cargo bench -p reth-provider --features \"test-utils,triedb\" --bench bench_state_root_overlay`\r\n  - [x] Run integration tests with `triedb` feature enabled\r\n\r\n  ## Related\r\n\r\n  - TrieDB repository: https://github.com/base/triedb\r\n  - TrieDB genesis performance issue: https://github.com/base/triedb/issues/179"
