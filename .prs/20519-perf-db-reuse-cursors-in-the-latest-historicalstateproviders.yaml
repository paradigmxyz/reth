number: 20519
title: 'perf(db): Reuse cursors in the Latest/HistoricalStateProviders'
state: open
author: mediocregopher
head: mediocregopher/historical-provider-reuse-cursors
base: main
labels:
- C-enhancement
- C-perf
- A-db
created_at: 2025-12-19T11:53:12Z
updated_at: 2026-01-21T11:31:26Z
additions: 299
deletions: 44
is_draft: false
files:
- path: crates/storage/db-api/src/cursor.rs
  additions: 48
  deletions: 0
- path: crates/storage/provider/src/providers/state/cursor_reuse.rs
  additions: 145
  deletions: 0
- path: crates/storage/provider/src/providers/state/historical.rs
  additions: 75
  deletions: 32
- path: crates/storage/provider/src/providers/state/latest.rs
  additions: 30
  deletions: 12
- path: crates/storage/provider/src/providers/state/mod.rs
  additions: 1
  deletions: 0
body: "This PR introduces a `ReusableCursor` type which automatically returns a cursor to a Cell on Drop. By holding a Cell for each table type we are able to reuse cursors in the state providers.\r\n\r\nI wanted to make this even more generic and automatic, so that we automatically reuse dropped cursors on every Tx, but doing so is a bigger lift. This should at least get us something useful.\r\n\r\nCloses #20492\r\n\r\n\r\nUpdate:\r\n\r\nThis introduces a owned/borrowed enum so that we can propagate borrowed cursors and instantiate owned resuable cursors, which we currently do in here:\r\n\r\nhttps://github.com/paradigmxyz/reth/blob/646fec9b4b36707b48d8271715c69d9c38cfddf8/crates/storage/provider/src/providers/database/provider.rs#L203-L203\r\n\r\nwe could further add an instance to:\r\n\r\nhttps://github.com/paradigmxyz/reth/blob/646fec9b4b36707b48d8271715c69d9c38cfddf8/crates/storage/provider/src/providers/database/provider.rs#L154-L154\r\n\r\nso that we can borrow there as well.\r\n\r\nthis is currently used in the execution stage:\r\n\r\nhttps://github.com/paradigmxyz/reth/blob/646fec9b4b36707b48d8271715c69d9c38cfddf8/crates/stages/stages/src/stages/execution.rs#L298-L298\r\n\r\nwhich is used for multi block execution so I believe the owned variant would be beneficial here as well\r\n\r\nCloses RETH-179"
