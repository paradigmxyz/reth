number: 21175
title: 'feat(stages): add RocksDB support for IndexStorageHistoryStage'
state: open
author: yongkangc
head: yk/rocksdb-index-storage-history-v3
base: main
labels:
- A-staged-sync
- A-db
created_at: 2026-01-18T22:39:42Z
updated_at: 2026-01-21T14:28:50Z
additions: 770
deletions: 208
is_draft: false
files:
- path: crates/stages/stages/src/stages/index_storage_history.rs
  additions: 330
  deletions: 26
- path: crates/stages/stages/src/stages/utils.rs
  additions: 196
  deletions: 164
- path: crates/storage/provider/src/either_writer.rs
  additions: 44
  deletions: 1
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 27
  deletions: 17
- path: crates/storage/provider/src/providers/rocksdb/provider.rs
  additions: 173
  deletions: 0
body: "Part of [#20390](https://github.com/paradigmxyz/reth/issues/20390)\r\n\r\nAdd RocksDB support to the storage history index stage using the `EitherWriter` abstraction\r\n\r\n### Changes\r\n\r\n- Add `RocksDBProviderFactory` and `StorageSettingsCache` trait bounds to Stage impl\r\n- Use `EitherWriter::new_storages_history()` to route writes to MDBX or RocksDB\r\n- Add helper functions for loading/flushing shards (`load_storage_history_via_writer`, etc.)\r\n- Add `EitherWriter` methods: `append_storage_history`, `upsert_storage_history`, `get_last_storage_history_shard`\r\n- Add `RocksDBProvider::clear()` and `RocksDBBatch::get()` methods\r\n- Add RocksDB-specific tests (execute, incremental sync, unwind checkpoint)\r\n\r\nCloses RETH-172\r\n---\r\n\r\n### PR Stack\r\n\r\n```\r\nmain\r\n  ↑\r\n#21165 (rocksdb-index-account-history)\r\n  ↑\r\n#21175 (rocksdb-index-storage-history + tx-hash-numbers) ◀ you are here\r\n```\r\n\r\n- https://github.com/paradigmxyz/reth/pull/21165 \r\n- https://github.com/paradigmxyz/reth/pull/21175 <"
