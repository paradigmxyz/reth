number: 21089
title: 'perf(trie): preserve allocations in sparse trie wipe()'
state: open
author: doocho
head: perf/preserve-storage-trie-allocations-on-wipe
base: main
labels: []
created_at: 2026-01-15T08:27:14Z
updated_at: 2026-01-21T08:04:38Z
additions: 11
deletions: 4
is_draft: false
files:
- path: crates/trie/sparse-parallel/src/trie.rs
  additions: 6
  deletions: 2
- path: crates/trie/sparse/src/trie.rs
  additions: 5
  deletions: 2
body: "Modify `wipe()` methods in sparse tries to preserve existing HashMap allocations instead of creating new ones. This follows the same pattern already used in `clear()` methods.\r\n\r\n**Note**: Since Cancun (EIP-6780), SELFDESTRUCT only fully destroys contracts created in the same transaction, significantly reducing when wipe() is triggered. The primary benefits are:\r\n1. Historical sync: Processing pre-Cancun blocks where SELFDESTRUCT was more common\r\n2. Code consistency: wipe() now follows the same allocation-preserving pattern as clear()\r\n3. Future-proofing: If wipe() is used for other purposes in the future\r\n\r\nCloses #16201"
