number: 21108
title: 'perf(provider): batch hashed state across blocks'
state: open
author: gakonst
head: joshie/batch-hashed-writes
base: main
labels:
- A-db
created_at: 2026-01-15T17:58:18Z
updated_at: 2026-01-19T11:08:01Z
additions: 658
deletions: 10
is_draft: true
files:
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 239
  deletions: 10
- path: crates/storage/provider/src/providers/mod.rs
  additions: 3
  deletions: 0
- path: crates/storage/provider/src/providers/sort.rs
  additions: 416
  deletions: 0
body: |-
  K-way merge for batched `save_blocks` hashed state writes.

  **Before:** Write each block separately, cursor jumps around B-tree.
  **After:** Merge all blocks, write in globally sorted order. Latest block wins for duplicates.

  **Changes:**
  - `providers/sort.rs`: `KMergeIter` heap-based merge, O(N log K)
  - `write_hashed_state_merged`: merged accounts + storage writes
  - Storage wipes: only merge blocks >= latest wipe

  19 tests verify equivalence to sequential application.
