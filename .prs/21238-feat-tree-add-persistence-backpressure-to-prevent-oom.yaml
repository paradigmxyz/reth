number: 21238
title: 'feat(tree): add persistence backpressure to prevent OOM'
state: open
author: gakonst
head: feat/persistence-backpressure
base: main
labels:
- A-engine
created_at: 2026-01-21T09:46:03Z
updated_at: 2026-01-21T10:03:04Z
additions: 113
deletions: 0
is_draft: true
files:
- path: crates/engine/primitives/src/config.rs
  additions: 27
  deletions: 0
- path: crates/engine/tree/src/tree/metrics.rs
  additions: 4
  deletions: 0
- path: crates/engine/tree/src/tree/mod.rs
  additions: 82
  deletions: 0
body: "## Summary\n\nWhen validation is faster than persistence (e.g., during `reth-bench` or `replay-payloads`), blocks can accumulate in memory faster than they can be written to disk, eventually causing OOM.\n\nThis adds a simple backpressure mechanism that prevents OOM by blocking validation when too many blocks are pending persistence.\n\n## Changes\n\n### New Config Option\n- `max_pending_persistence_blocks` (default: 128) - Maximum blocks that can be pending persistence before backpressure is applied\n\n### New Methods in `EngineApiTreeHandler`\n- `pending_persistence_blocks()` - Returns count of blocks awaiting persistence\n- `should_apply_backpressure()` - Returns true if limit is exceeded  \n- `wait_for_persistence_if_needed()` - Blocks until persistence catches up\n\n### Metrics\n- `pending_persistence_blocks` gauge - Current pending blocks count\n- `backpressure_events` counter - Number of times backpressure was applied\n\n## How It Works\n\n1. Before inserting a new payload, check if `pending_persistence_blocks >= max_pending_persistence_blocks`\n2. If true, block on the persistence channel until a persistence operation completes\n3. This naturally couples validation speed to persistence speed, preventing unbounded memory growth\n\n## Impact\n\n- **Benchmarks**: May show lower peak validation throughput (measures end-to-end including disk, not just CPU)\n- **Live sync**: Minimal impact since persistence usually keeps up; reasonable buffer prevents stalls\n- **OOM prevention**: No more crashes when running `reth-bench` or `replay-payloads` with many blocks\n\n## Related Discussion\n\nFrom Slack thread in #eng-perf: validation was outpacing persistence during benchmarking, causing OOM after ~100-150 blocks.\n\ncc @onbjerg @mattsse @joshieDo @gakonst @yk \n\n---\n\n*This PR was created based on discussion about adding simple backpressure where there should be a max number of blocks to persist. The implementation blocks validation when the persistence queue is too full.*\n"
