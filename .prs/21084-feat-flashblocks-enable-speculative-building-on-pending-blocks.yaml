number: 21084
title: 'feat(flashblocks): enable speculative building on pending blocks'
state: open
author: teddyknox
head: teddyknox/speculative-execution
base: main
labels: []
created_at: 2026-01-14T23:28:51Z
updated_at: 2026-01-14T23:28:52Z
additions: 2026
deletions: 48
is_draft: false
files:
- path: crates/optimism/flashblocks/src/cache.rs
  additions: 410
  deletions: 19
- path: crates/optimism/flashblocks/src/lib.rs
  additions: 6
  deletions: 1
- path: crates/optimism/flashblocks/src/pending_state.rs
  additions: 148
  deletions: 0
- path: crates/optimism/flashblocks/src/service.rs
  additions: 104
  deletions: 11
- path: crates/optimism/flashblocks/src/validation.rs
  additions: 548
  deletions: 0
- path: crates/optimism/flashblocks/src/worker.rs
  additions: 89
  deletions: 17
- path: crates/optimism/flashblocks/tests/it/harness.rs
  additions: 439
  deletions: 0
- path: crates/optimism/flashblocks/tests/it/main.rs
  additions: 2
  deletions: 0
- path: crates/optimism/flashblocks/tests/it/service.rs
  additions: 280
  deletions: 0
body: "## Summary\r\n\r\nEnable building flashblocks on top of pending blocks before their canonical parent arrives via P2P, reducing latency when flashblocks arrive faster than canonical blocks.\r\n\r\nPart of the [speculative flashblock building design](https://www.notion.so/oplabs/Flashblocks-Upstreaming-node-reth-features-2e8f153ee162805eaaa5f067fe3440a3?source=copy_link). Builds on [PR 2](https://github.com/op-rs/op-reth/pull/591), and will rebase to target https://github.com/paradigmxyz/reth once it merges.\r\n\r\n## Motivation\r\n\r\nThe sequence manager currently discards flashblocks whose parent hash doesn't match the canonical tip. This means flashblocks for block N+1 sit idle until block N propagates via P2Pâ€”negating the latency advantage of the WebSocket feed.\r\n\r\nWith speculative building, we track execution state from previous builds and use it as prestate for subsequent builds, allowing continuous flashblock processing without waiting for P2P.\r\n\r\n## Changes\r\n\r\n**`pending_state.rs`** (new)\r\n- `PendingBlockState<N>` - Tracks block hash, number, parent hash, execution outcome, and cached reads from a build\r\n- `PendingStateRegistry<N>` - Stores most recent pending state for use by subsequent builds\r\n\r\n**`cache.rs`**\r\n- Extend `next_buildable_args()` with 3-priority build selection:\r\n  1. Canonical-Pending: pending sequence parent matches canonical tip\r\n  2. Canonical-Cached: cached sequence parent matches canonical tip  \r\n  3. Speculative: pending/cached sequence parent matches pending state's block hash\r\n- Add `pending_parent` field to `BuildArgs`\r\n\r\n**`worker.rs`**\r\n- Accept optional `pending_parent` in `BuildArgs`\r\n- Use `with_bundle_prestate()` to overlay pending state's bundle on the canonical state provider\r\n- Return `PendingBlockState` in `BuildResult` for use by subsequent builds\r\n\r\n**`service.rs`**\r\n- Add `PendingStateRegistry` field\r\n- Record pending state after successful builds\r\n- Pass pending state to `next_buildable_args()`\r\n- Clear pending states on reconciliation\r\n- Add `with_speculative_building()` opt-in (disabled by default)\r\n\r\n## Testing\r\n\r\nNew integration test harness in `tests/it/`:\r\n- `harness.rs` - `FlashBlockServiceTestHarness`, `TestSequenceManager`, `TestFlashBlockFactory`\r\n- `service.rs` - Tests for speculative build priority, canonical precedence, pending state registry, depth limits\r\n"
