number: 21236
title: 'refactor(stages): deduplicate account/storage history shard loading'
state: open
author: gakonst
head: yk/dedup-history-shard-ops
base: main
labels: []
created_at: 2026-01-21T08:53:20Z
updated_at: 2026-01-21T14:10:14Z
additions: 782
deletions: 367
is_draft: true
files:
- path: crates/stages/stages/src/stages/index_storage_history.rs
  additions: 330
  deletions: 26
- path: crates/stages/stages/src/stages/utils.rs
  additions: 208
  deletions: 323
- path: crates/storage/provider/src/either_writer.rs
  additions: 44
  deletions: 1
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 27
  deletions: 17
- path: crates/storage/provider/src/providers/rocksdb/provider.rs
  additions: 173
  deletions: 0
body: "## Summary\nIntroduces a generic `load_sharded_history` function that consolidates the duplicated shard-loading logic between account history and storage history stages. This reduces ~94 net lines of code.\n\n## Changes\n- Creates generic `load_sharded_history`, `flush_shards`, and `flush_shards_partial` functions with closure parameters\n- `load_account_history` and `load_storage_history` are now thin wrappers passing table-specific closures\n- Preserves all invariants:\n  - `u64::MAX` sentinel key for final shard (enables incremental sync lookups)\n  - Append vs upsert semantics based on `append_only` flag  \n  - Partial shard buffering (keep last shard buffered for continued accumulation)\n- Both MDBX and RocksDB backends continue to work via EitherWriter\n\n## Motivation\nPer discussion in #21175 and #21165, there was significant code duplication between account history and storage history shard writers. This refactor follows Design 3 (closures without traits) as discussed.\n\n## Testing\n- [x] `cargo check -p reth-stages` passes\n- [ ] Existing tests should pass (CI will verify)\n\nBuilds on #21175"
