number: 21202
title: 'perf(trie): parallelize merge_ancestors_into_overlay'
state: open
author: mattsse
head: mattsse/parallel-merge-ancestors-v2
base: main
labels:
- C-perf
- A-trie
created_at: 2026-01-20T09:45:42Z
updated_at: 2026-01-21T08:37:24Z
additions: 113
deletions: 3
is_draft: false
files:
- path: crates/chain-state/src/deferred_trie.rs
  additions: 47
  deletions: 2
- path: crates/trie/common/src/hashed_state.rs
  additions: 33
  deletions: 1
- path: crates/trie/common/src/updates.rs
  additions: 33
  deletions: 0
body: |-
  ## Summary

  Adds parallel merge support for the deferred trie computation fallback path when rebuilding overlays from ancestors.

  ## Changes

  - Add `merge_parallel` methods to `HashedPostStateSorted` and `TrieUpdatesSorted` using ordered parallel tree reduction (preserves newest-wins ordering)
  - Feature-gate parallel implementation behind `rayon` feature with sequential fallback
  - Add early exit when ancestors list is empty
  - Use `rayon::join` to merge states and updates concurrently

  ## Implementation

  The parallel merge uses an iterative tree reduction pattern with `par_chunks` at each level:

  ```
  Level 0:  A0    A1    A2    A3    A4    A5    A6    A7
              \  /        \  /        \  /        \  /
  Level 1:   M01          M23         M45         M67    ← parallel
                \        /              \        /
  Level 2:      M0123                   M4567            ← parallel
                      \                /
  Level 3:            M01234567 (final)
  ```

  This ensures order preservation (critical for "newer overwrites older" semantics) while still benefiting from parallelism.

  Follow-up to #21193 which adds the parallel `into_sorted` changes.

  Closes #21187
