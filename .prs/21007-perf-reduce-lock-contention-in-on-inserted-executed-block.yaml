number: 21007
title: 'perf: reduce lock contention in on_inserted_executed_block'
state: open
author: yongkangc
head: yk/save-cache-lock-contention
base: main
labels: []
created_at: 2026-01-13T16:51:24Z
updated_at: 2026-01-20T23:35:16Z
additions: 61
deletions: 40
is_draft: true
files:
- path: crates/engine/tree/src/tree/payload_processor/mod.rs
  additions: 46
  deletions: 22
- path: crates/engine/tree/src/tree/payload_processor/prewarm.rs
  additions: 15
  deletions: 18
body: "**Summary**\r\nMove expensive `insert_state` operation outside the write lock to eliminate 10-25ms blocking on `get_cache_for` reads.\r\n`Blocked waiting for execution cache mutex blocked_for=25ms`\r\n\r\n**Changes**\r\n- Restructure `on_inserted_executed_block` to use two brief lock acquisitions instead of one long hold\r\n- Add `update_with_guard_return` helper to extract data from lock closure\r\n- Add race-safety guard to avoid clobbering newer cache entries\r\n\r\n**Before**\r\n```\r\nLock acquired → check parent → take cache → insert_state (10-25ms) → swap → release\r\n```\r\n\r\n**After**\r\n```\r\nLock acquired → check parent → take cache → release (fast)\r\ninsert_state (10-25ms, no lock held)\r\nLock acquired → swap → release (fast)\r\n```"
