number: 21216
title: 'fix(rocksdb): correct history index divergence causing nonce errors after unwind'
state: open
author: yongkangc
head: fix/rocksdb-history-divergence
base: main
labels:
- C-bug
- A-db
- A-rocksdb
created_at: 2026-01-20T16:40:04Z
updated_at: 2026-01-20T18:16:05Z
additions: 315
deletions: 87
is_draft: true
files:
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 41
  deletions: 5
- path: crates/storage/provider/src/providers/rocksdb/invariants.rs
  additions: 116
  deletions: 52
- path: crates/storage/provider/src/providers/rocksdb/mod.rs
  additions: 4
  deletions: 1
- path: crates/storage/provider/src/providers/rocksdb/provider.rs
  additions: 145
  deletions: 29
- path: crates/storage/provider/src/providers/rocksdb_stub.rs
  additions: 9
  deletions: 0
body: "## Summary\r\n\r\nFix execution divergence in RocksDB hybrid storage that caused \"nonce too high\" errors during `engine_newPayload` after unwinding blocks.\r\n\r\n### Problem\r\n\r\nWhen running `reth-bench new-payload-fcu` with RocksDB hybrid storage enabled, the benchmark would fail with nonce errors after unwinding and replaying blocks. The root cause was a mismatch between what RocksDB and MDBX recorded in their history indices.\r\n\r\n## Root Causes Fixed\r\n\r\n### 1. Over-approximation of Account History\r\nRocksDB was recording history indices for **all touched accounts**, including those with only storage changes. This diverged from MDBX's `AccountChangeSets` which only records accounts where account-info (nonce, balance, code_hash) changed or the account was created/destroyed.\r\n\r\n**Fix:** Use `account.is_info_changed() || account.was_destroyed()` instead of `!account.status.is_not_modified()` to match MDBX semantics exactly.\r\n\r\n### 2. Missing Plain State Fallback\r\nWhen RocksDB history lookup found no entry for an address, it returned `HistoryInfo::NotYetWritten` (account doesn't exist). In hybrid storage, accounts modified **before** RocksDB was enabled exist only in MDBX.\r\n\r\n**Fix:** Always fall back to `HistoryInfo::MaybeInPlainState` so pre-existing accounts are correctly looked up in MDBX plain state.\r\n\r\n### 3. Commit Order Race Condition\r\nRocksDB history indices were committed before MDBX changesets. If a reader followed a history index to a changeset during this window, the changeset might not exist yet.\r\n\r\n**Fix:** Commit MDBX first, then RocksDB history indices.\r\n\r\n## Additional Improvements\r\n\r\n- Improved sentinel shard handling in invariants: pruning now correctly filters block numbers within sentinel shards (`highest_block_number=u64::MAX`)\r\n- Pending history writes are accumulated across `save_blocks()` calls and materialized once at commit time, fixing read-your-writes issues\r\n\r\n## Testing\r\n\r\nVerified by running `reth-bench new-payload-fcu` for 750 blocks, which previously reproduced the \"nonce too high\" error. It now completes without any errors.\r\n"
