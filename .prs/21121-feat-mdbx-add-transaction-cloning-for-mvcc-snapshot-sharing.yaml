number: 21121
title: 'feat(mdbx): add transaction cloning for MVCC snapshot sharing'
state: open
author: gakonst
head: feat/mdbx-txn-cloning
base: main
labels:
- C-perf
- A-db
created_at: 2026-01-16T14:11:58Z
updated_at: 2026-01-16T14:11:59Z
additions: 17455
deletions: 6024
is_draft: false
files:
- path: crates/storage/db-api/src/lib.rs
  additions: 2
  deletions: 0
- path: crates/storage/db-api/src/transaction.rs
  additions: 17
  deletions: 0
- path: crates/storage/db/src/implementation/mdbx/tx.rs
  additions: 37
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/build.rs
  additions: 3
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/CMakeLists.txt
  additions: 108
  deletions: 365
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/COPYRIGHT
  additions: 159
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ChangeLog.md
  additions: 2144
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/GNUmakefile
  additions: 72
  deletions: 23
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/NOTICE
  additions: 13
  deletions: 9
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/README.md
  additions: 528
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/VERSION.json
  additions: 1
  deletions: 1
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ci.sh
  additions: 82
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/cmake/compiler.cmake
  additions: 1
  deletions: 4
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/cmake/profile.cmake
  additions: 1
  deletions: 1
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/cmake/utils.cmake
  additions: 15
  deletions: 197
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/config.h.in
  additions: 11
  deletions: 3
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_chk.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_copy.1
  additions: 7
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_drop.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_dump.1
  additions: 7
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_load.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/man1/mdbx_stat.1
  additions: 2
  deletions: 2
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.c
  additions: 6732
  deletions: 3752
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.c++
  additions: 4132
  deletions: 206
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.h
  additions: 442
  deletions: 53
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx.h++
  additions: 1145
  deletions: 1036
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_chk.c
  additions: 153
  deletions: 66
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_copy.c
  additions: 132
  deletions: 45
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_drop.c
  additions: 129
  deletions: 45
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_dump.c
  additions: 161
  deletions: 82
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_load.c
  additions: 140
  deletions: 47
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/mdbx_stat.c
  additions: 161
  deletions: 70
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/packages/archlinux/.SRCINFO
  additions: 16
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/packages/archlinux/PKGBUILD
  additions: 38
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/packages/buildroot/0001-package-libmdbx.patch
  additions: 75
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/CMakeLists.txt
  additions: 43
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/README.md
  additions: 11
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/example-mdbx.c
  additions: 167
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/example-mdbx.c++
  additions: 41
  deletions: 0
- path: crates/storage/libmdbx-rs/mdbx-sys/libmdbx/ut_and_examples/pcrf/pcrf_simulator.c
  additions: 367
  deletions: 0
- path: crates/storage/libmdbx-rs/src/error.rs
  additions: 10
  deletions: 0
- path: crates/storage/libmdbx-rs/src/transaction.rs
  additions: 26
  deletions: 0
- path: crates/storage/provider/src/providers/database/provider.rs
  additions: 37
  deletions: 2
- path: crates/storage/provider/src/providers/state/overlay.rs
  additions: 42
  deletions: 3
- path: crates/storage/storage-api/src/database_provider.rs
  additions: 39
  deletions: 0
body: |-
  ## Summary

  Introduces `mdbx_txn_clone` support to fix cache misses during payload validation when persistence advances the database tip while proof workers are operating.

  ### Problem

  During payload validation, proof task workers create new MDBX transactions. If persistence commits and advances the DB tip mid-validation:
  - Workers get transactions at the new tip (e.g., block 8)
  - But the in-memory overlay is anchored at the old tip (e.g., block 5)
  - This mismatch forces state reverts → **~34% cache miss rate**

  ### Solution

  Allow workers to **clone** from a shared origin transaction instead of creating new ones:
  - All workers read from the same MVCC snapshot
  - No anchor mismatch regardless of persistence timing
  - Eliminates unnecessary cache misses

  ### Key Changes

  1. **Update vendored libmdbx** (v0.13.7 → v0.14.1.273)
     - Includes `mdbx_txn_clone` from upstream master

  2. **Add Rust bindings for transaction cloning**
     - `Transaction::clone_snapshot()` - low-level MDBX wrapper
     - `Tx::clone_snapshot()` - reth-db wrapper with metrics
     - `CloneableDbTx` trait implementation

  3. **Add provider-level cloning traits**
     - `CloneableProvider` - for providers with cloneable transactions
     - `CloneableProviderFactory` - factory that can clone from origin
     - Implemented for `DatabaseProvider` and `OverlayStateProviderFactory`

  4. **Wire up proof task workers**
     - `ProofTaskCtx::with_origin_provider()` - share an origin provider
     - `database_provider_ro_cloned()` - clones from origin when available
     - Workers now use cloned transactions by default

  ### Usage

  ```rust
  // Create origin provider at validation start
  let origin_provider = factory.database_provider_ro()?;

  // Workers will clone from this snapshot
  let task_ctx = ProofTaskCtx::with_origin_provider(factory, origin_provider);
  let handle = ProofWorkerHandle::new(executor, task_ctx, ...);
  ```

  ### Related

  - Analysis thread: https://ampcode.com/threads/T-019bc45f-e489-73da-aeff-cd5db0c100bd
  - PR #20997 (in-memory trie changeset cache) addresses I/O overhead but not the anchor mismatch

  ---

  **Note**: libmdbx v0.14.1.273 is from master branch as `mdbx_txn_clone` hasn't been released yet. We should track the next stable release.
