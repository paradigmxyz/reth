number: 20714
title: 'refactor(trie): consolidate StorageTries parallel maps into one'
state: open
author: figtracer
head: refactor_storage_tries
base: main
labels: []
created_at: 2026-01-02T21:10:16Z
updated_at: 2026-01-13T13:19:19Z
additions: 133
deletions: 117
is_draft: false
files:
- path: crates/engine/tree/src/tree/payload_processor/sparse_trie.rs
  additions: 10
  deletions: 10
- path: crates/stateless/src/trie.rs
  additions: 13
  deletions: 10
- path: crates/trie/sparse/src/state.rs
  additions: 110
  deletions: 97
body: "- created new struct `StorageTrieEntry` for better cache locality\r\n- updated all calling sites to use this new struct\r\n\r\nthis makes storage related lookups in the sparse trie 2x faster and we also save 48 bytes per `StorageTrie` instance\r\n\r\nbenchmark results:\r\n\r\n| Op        | Size | Old (two maps) | New (single map) | Speedup   |\r\n| ----------------- | ---- | -------------- | ---------------- | --------- |\r\n| **Lookup**        | 100  | 612 ns         | 280 ns           | **2.19x** |\r\n| **Lookup**        | 1000 | 7.35 µs        | 3.31 µs          | **2.22x** |\r\n| **Lookup**        | 5000 | 35.6 µs        | 15.6 µs          | **2.28x** |\r\n| **Clear**         | 500  | 14.2 µs        | 12.5 µs          | **1.14x** |\r\n| **Insert**        | 5000 | 1.54 ms        | 1.51 ms          | **1.02x** |\r\n\r\n"
