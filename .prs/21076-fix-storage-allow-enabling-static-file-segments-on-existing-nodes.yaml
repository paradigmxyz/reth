number: 21076
title: 'fix(storage): allow enabling static file segments on existing nodes'
state: open
author: gakonst
head: fix/enable-static-file-segments-existing-nodes
base: main
labels:
- C-bug
- A-db
created_at: 2026-01-14T21:43:38Z
updated_at: 2026-01-14T22:20:43Z
additions: 30
deletions: 32
is_draft: true
files:
- path: crates/storage/provider/src/providers/static_file/manager.rs
  additions: 13
  deletions: 30
- path: crates/storage/provider/src/providers/static_file/writer.rs
  additions: 17
  deletions: 2
body: |-
  ## Summary

  This PR contains two stacked changes:

  ### 1. Remove gap check between database and static files (Closes #19721)

  Data types no longer exist simultaneously in static files and database. Headers, transactions, etc. are only written to static files now, never to the database. This makes the continuity gap check unnecessary.

  ### 2. Allow enabling static file segments on existing nodes

  When a user runs `reth db settings set transaction_senders true` (or `account_changesets true`) on an existing node that was previously running with these settings as `false`, the node would fail to start.

  The `ensure_invariants` function was incorrectly detecting data corruption when the static file was empty (never had data) but the stage checkpoint was ahead. The code would default `highest_static_file_block` to 0 and compare it with the checkpoint, triggering an incorrect unwind to block 0.

  This fix adds an early return at the start of `ensure_invariants` when the static file is truly empty (both `highest_static_file_entry` and `highest_static_file_block` are None). This is treated as a valid "fresh start" scenario when enabling static files for the first time.

  ## Acceptance Criteria

  - ✅ Node starts successfully after enabling any static file segment on an existing node (when the static file is empty)
  - ✅ Gap check removed since data no longer exists simultaneously in DB and static files
  - ✅ Logic is generalized across segment types
