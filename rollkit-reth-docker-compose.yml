name: "rollkit-reth"

services:
  jwt-init:
    container_name: jwt-init
    image: alpine:3.19
    volumes:
      - ./jwttoken:/jwt
    healthcheck:
      test: ["CMD", "test", "-f", "/jwt/jwt.hex"]
      interval: 5s
      timeout: 5s
      retries: 3
    command: >
      /bin/sh -c "mkdir -p /jwt &&
      if [ ! -f /jwt/jwt.hex ]; then
        apk add --no-cache openssl &&
        openssl rand -hex 32 | tr -d '\n' > /jwt/jwt.hex;
      fi"

  rollkit-reth:
    container_name: rollkit-reth
    restart: unless-stopped
    build:
      context: .
      dockerfile: Dockerfile.rollkit
      args:
        BUILD_PROFILE: release
        FEATURES: "jemalloc"
    depends_on:
      jwt-init:
        condition: service_completed_successfully
    ports:
      - "9001:9001"   # metrics
      - "30303:30303" # eth/66 peering
      - "8545:8545"   # HTTP RPC
      - "8551:8551"   # Engine API (authenticated)
      - "8546:8546"   # WebSocket RPC
    volumes:
      - ./jwttoken:/jwt:ro
      - rollkit_data:/data
    environment:
      - RUST_LOG=info,rollkit_reth=debug,rollkit_payload_builder=debug
      - RUST_BACKTRACE=1
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8545 -X POST -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    command: >
      node
      --chain=dev
      --rollkit
      --rollkit-gas-limit=50000000
      --engine-tx-passthrough
      --datadir=/data
      --http
      --http.addr=0.0.0.0
      --http.port=8545
      --http.api=eth,net,web3,txpool
      --ws
      --ws.addr=0.0.0.0
      --ws.port=8546
      --authrpc.addr=0.0.0.0
      --authrpc.port=8551
      --authrpc.jwtsecret=/jwt/jwt.hex
      --metrics=0.0.0.0:9001
      --log.stdout.format=terminal

volumes:
  rollkit_data:
    driver: local 