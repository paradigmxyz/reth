{
  "project": "reth-rocksdb-benchmark",
  "branchName": "ralph/rocksdb-benchmark",
  "description": "RocksDB vs MDBX Performance Benchmarking - Measure performance impact of RocksDB integration for historical tables compared to MDBX-only baseline on Hoodi network",
  "userStories": [
    {
      "id": "US-001",
      "title": "Build reth with RocksDB feature",
      "description": "As a developer, I need to build reth and reth-bench with RocksDB support so that benchmarks can test both storage backends.",
      "acceptanceCriteria": [
        "Run: cargo build --release -p reth -p reth-bench --features 'jemalloc asm-keccak rocksdb'",
        "Binary exists at ./target/release/reth",
        "Binary exists at ./target/release/reth-bench",
        "Verify RocksDB feature is enabled: ./target/release/reth --help | grep -q storage"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Binaries exist with RocksDB feature. Flags available: --storage.tx-hash-in-rocksdb, --storage.storages-history-in-rocksdb, --storage.account-history-in-rocksdb"
    },
    {
      "id": "US-002",
      "title": "Generate JWT secret for benchmark",
      "description": "As a benchmark runner, I need a JWT secret file so that reth and reth-bench can authenticate.",
      "acceptanceCriteria": [
        "JWT secret file exists at /tmp/jwt-benchmark.hex",
        "File contains 32 bytes of hex (64 characters)",
        "Command: openssl rand -hex 32 > /tmp/jwt-benchmark.hex"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created with openssl rand -hex 32, 64 hex characters"
    },
    {
      "id": "US-003",
      "title": "Start Jaeger for tracing",
      "description": "As a developer, I need Jaeger running so that I can analyze detailed trace spans during benchmarks.",
      "acceptanceCriteria": [
        "Run: docker run -d --name jaeger-bench -p 16686:16686 -p 4317:4317 -p 4318:4318 cr.jaegertracing.io/jaegertracing/jaeger:2.11.0",
        "Jaeger UI accessible at http://localhost:16686",
        "Verify with: curl -s http://localhost:16686/api/services | grep -q jaeger-query"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Configure Prometheus for benchmark scraping",
      "description": "As a developer, I need Prometheus configured to scrape both MDBX and RocksDB benchmark instances.",
      "acceptanceCriteria": [
        "Add job 'reth-bench-mdbx' targeting localhost:9100 with labels storage='mdbx'",
        "Add job 'reth-bench-rocks' targeting localhost:9101 with labels storage='rocksdb'",
        "Update /home/yk/tempo/reth-grafana/monitoring/prometheus.yml",
        "Restart Prometheus: cd /home/yk/tempo/reth-grafana/monitoring && docker-compose restart prometheus"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Verify Hoodi data directories exist",
      "description": "As a benchmark runner, I need to verify the Hoodi data directories exist and determine the current block height.",
      "acceptanceCriteria": [
        "Check if HOODI_DATADIR_MDBX exists (or create note about required path)",
        "Check if HOODI_DATADIR_ROCKS exists (or create note about required path)",
        "Determine current block height by checking chaindata",
        "Document start block for benchmark (current_head - 1000)"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Unwind MDBX node to start block",
      "description": "As a benchmark runner, I need to unwind the MDBX node to a consistent starting point.",
      "acceptanceCriteria": [
        "Run: ./target/release/reth stage unwind to-block $START_BLOCK --datadir $HOODI_DATADIR_MDBX --chain hoodi",
        "Command completes successfully",
        "Log output indicates unwind completed"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Run MDBX baseline benchmark",
      "description": "As a benchmark runner, I need to run the MDBX baseline benchmark for 1000 blocks.",
      "acceptanceCriteria": [
        "Start reth node: ./target/release/reth node --chain hoodi --datadir $HOODI_DATADIR_MDBX --metrics localhost:9100 --authrpc.port 8551 --authrpc.jwtsecret /tmp/jwt-benchmark.hex",
        "Wait for node to be ready (check auth RPC)",
        "Run benchmark: ./target/release/reth-bench new-payload-fcu --rpc-url $RPC_URL --engine-rpc-url http://localhost:8551 --jwt-secret /tmp/jwt-benchmark.hex --from $START_BLOCK --to $((START_BLOCK + 1000)) --output ./benchmark-results/mdbx_benchmark.csv --wait-for-persistence",
        "CSV output file exists at ./benchmark-results/mdbx_benchmark.csv",
        "Stop reth node gracefully"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Unwind RocksDB node to start block",
      "description": "As a benchmark runner, I need to unwind the RocksDB node to the same starting point.",
      "acceptanceCriteria": [
        "Run: ./target/release/reth stage unwind to-block $START_BLOCK --datadir $HOODI_DATADIR_ROCKS --chain hoodi",
        "Command completes successfully",
        "Log output indicates unwind completed"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Run RocksDB benchmark",
      "description": "As a benchmark runner, I need to run the RocksDB benchmark for 1000 blocks.",
      "acceptanceCriteria": [
        "Start reth node with RocksDB: ./target/release/reth node --chain hoodi --datadir $HOODI_DATADIR_ROCKS --metrics localhost:9101 --authrpc.port 8552 --authrpc.jwtsecret /tmp/jwt-benchmark.hex --storage.transaction-hash-numbers-in-rocksdb --storage.accounts-history-in-rocksdb --storage.storages-history-in-rocksdb",
        "Wait for node to be ready",
        "Run benchmark: ./target/release/reth-bench new-payload-fcu --rpc-url $RPC_URL --engine-rpc-url http://localhost:8552 --jwt-secret /tmp/jwt-benchmark.hex --from $START_BLOCK --to $((START_BLOCK + 1000)) --output ./benchmark-results/rocks_benchmark.csv --wait-for-persistence",
        "CSV output file exists at ./benchmark-results/rocks_benchmark.csv",
        "Stop reth node gracefully"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Generate comparison report",
      "description": "As a developer, I want to see a comparison of MDBX vs RocksDB performance.",
      "acceptanceCriteria": [
        "Parse both CSV files (mdbx_benchmark.csv and rocks_benchmark.csv)",
        "Calculate average gas/second for both backends",
        "Calculate average latency for both backends",
        "Calculate percentage difference (RocksDB vs MDBX)",
        "Output summary to ./benchmark-results/comparison_report.txt"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Capture Grafana dashboard snapshot",
      "description": "As a developer, I want a screenshot of the Grafana benchmark dashboard.",
      "acceptanceCriteria": [
        "Navigate to Grafana dashboard at https://reth-g.chiayong.com",
        "Open RocksDB vs MDBX Benchmark dashboard",
        "Take screenshot showing Gas Throughput, Block Execution Time, and RocksDB metrics",
        "Save screenshot to ./benchmark-results/grafana_snapshot.png"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Analyze Jaeger traces",
      "description": "As a developer, I want to identify performance bottlenecks from Jaeger traces.",
      "acceptanceCriteria": [
        "Access Jaeger UI at http://localhost:16686",
        "Find traces for new_payload, execute_block, commit_state spans",
        "Compare span durations between MDBX and RocksDB runs",
        "Document findings in ./benchmark-results/trace_analysis.md"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Cleanup benchmark resources",
      "description": "As a developer, I need to clean up Docker containers and reset Prometheus config.",
      "acceptanceCriteria": [
        "Stop and remove Jaeger container: docker stop jaeger-bench && docker rm jaeger-bench",
        "Remove benchmark jobs from prometheus.yml",
        "Restart Prometheus",
        "Verify benchmark results are saved before cleanup"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
